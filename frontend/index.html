<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wochenkalender & Ereignisse</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI Bold', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            font-weight: bold;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            height: 100vh;
            margin: 0;
            padding: 0;
            overflow: hidden;
        }

        :root {
            /* Calendar theme colors - tweak these to test combinations */
            --calendar-yellow: rgb(255, 255, 204);
            --calendar-yellow-rgb: 255, 255, 204;
            --calendar-red: rgb(255, 229, 204);
            --calendar-red-rgb: 255, 229, 204;
            --calendar-white: rgb(255, 255, 255);
            --calendar-white-rgb: 255, 255, 255;
        }

        .container {
            width: 100vw;
            height: calc(100vh - 142px);
            background: transparent;
            display: flex;
            padding: 20px;
            gap: 20px;
        }

        /* Generic card */
        .card {
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            background: rgba(255, 255, 255, 0.95);
            box-shadow: 0 8px 16px rgba(0,0,0,0.06);
        }

        /* Top navigation bar */
        .top-nav {
            width: 100vw;
            height: 112px;
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            display: flex;
            flex-direction: column;
            justify-content: center;
            padding: 10px 0 20px 0;
            gap: 6px;
            margin-bottom: 10px;
        }

        .header-row {
            width: 100%;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .header-left,
        .header-center,
        .header-right {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .header-left {
            padding-left: 20px;
        }

        .header-right {
            padding-right: 20px;
        }

        .header-center {
            justify-content: center;
            flex: 1;
        }
        /* Make top-right buttons uniform size */
        .header-right .nav-item {
            width: 40px;
            height: 40px;
            padding: 0;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }

        .app-logo {
            height: 52px;
            border-radius: 6px;
            margin-left: 8px;
            margin-top: 16px;
        }

        

        .burger {
            width: 40px;
            height: 40px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            border: 1px solid rgba(102, 126, 234, 0.35);
            background: linear-gradient(135deg, rgba(255,255,255,0.9), rgba(255,255,255,0.7));
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .burger:hover { background: rgba(102, 126, 234, 0.12); }

        .burger .bar {
            width: 22px;
            height: 3px;
            background: #333;
            position: relative;
        }

        .burger .bar::before,
        .burger .bar::after {
            content: '';
            position: absolute;
            left: 0;
            width: 22px;
            height: 3px;
            background: #333;
        }

        .burger .bar::before { top: -6px; }
        .burger .bar::after { top: 6px; }

        .nav-item {
            appearance: none;
            border: 1px solid rgba(102, 126, 234, 0.35);
            background: linear-gradient(135deg, rgba(255,255,255,0.9), rgba(255,255,255,0.7));
            color: #333;
            padding: 12px 18px;
            border-radius: 10px;
            cursor: pointer;
            font-weight: bold;
            font-size: 12px;
            transition: all 0.2s ease;
        }


        .nav-item:hover {
            background: rgba(102, 126, 234, 0.12);
        }

        .nav-item.active {
            color: white;
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.9), rgba(118, 75, 162, 0.9));
            border-color: rgba(102, 126, 234, 0.8);
            text-shadow: 0 1px 2px rgba(0,0,0,0.25);
        }

        /* Views */
        .view { display: none; }
        .view.active { display: block; }

        .calendar-section {
            flex: 2;
            padding: 20px;
            background: rgba(255, 255, 255, 0.95);
            display: flex;
            flex-direction: column;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            box-shadow: 0 8px 16px rgba(0,0,0,0.06);
            position: relative;
        }

        .notes-section {
            flex: 1;
            padding: 0 0;
            display: flex;
            flex-direction: column;
        }

        .calendar-actions {
            position: absolute;
            top: 16px;
            right: 16px;
            display: flex;
            gap: 8px;
        }

        .events-card {
            padding: 20px;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            background: rgba(255, 255, 255, 0.95);
            box-shadow: 0 8px 16px rgba(0,0,0,0.06);
            display: flex;
            flex-direction: column;
            height: 100%;
        }

        .calendar-header {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            margin-bottom: 20px;
            flex-shrink: 0;
            gap: 10px;
        }

        .week-year {
            font-size: 24px;
            font-weight: normal;
            color: #333;
        }

        .calendar-legend {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 16px;
            flex-wrap: wrap;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            background: rgba(255, 255, 255, 0.9);
            padding: 8px 16px;
            border-radius: 20px;
            border: 1px solid #e0e0e0;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .legend-color {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            border: 1px solid rgba(0,0,0,0.1);
        }

        .legend-text {
            font-size: 14px;
            font-weight: 600;
            color: #333;
        }

        .card-title {
            font-size: 24px;
            font-weight: bold;
            color: #333;
        }

        .week-grid {
            display: grid;
            grid-template-columns: 80px repeat(5, 1fr);
            gap: 1px;
            background: #e5e7eb;
            border: 1px solid #e5e7eb;
            flex: 1;
            overflow-y: auto;
            min-height: 0;
        }

        .week-grid .header {
            font-weight: bold;
            background: rgba(255, 255, 255, 0.9);
            color: #000;
            text-align: center;
            padding: 10px 0;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        /* Colorful weekday headers */
        .week-grid .header.montag {
            background: linear-gradient(135deg, var(--calendar-yellow), var(--calendar-yellow));
            color: #333;
        }

        .week-grid .header.dienstag {
            background: linear-gradient(135deg, var(--calendar-white), var(--calendar-white));
            color: #333;
        }

        .week-grid .header.mittwoch {
            background: linear-gradient(135deg, var(--calendar-red), var(--calendar-red));
            color: #000;
        }

        .week-grid .header.donnerstag {
            background: linear-gradient(135deg, var(--calendar-red), var(--calendar-red));
            color: #000;
        }

        .week-grid .header.freitag {
            background: linear-gradient(135deg, var(--calendar-yellow), var(--calendar-yellow));
            color: #333;
        }



        .time-cell {
            background: rgba(255, 255, 255, 0.8);
            color: #666;
            font-size: 11px;
            padding: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            height: 40px;
        }

        .slot-cell {
            background: rgba(255, 255, 255, 0.8);
            height: 40px;
            position: relative;
            cursor: pointer;
            transition: background 0.2s ease;
            border-bottom: 1px solid rgba(0, 0, 0, 0.05);
        }

        .slot-cell:hover {
            background: rgba(102, 126, 234, 0.15);
        }

        /* Colorful day columns - moved after general slot-cell rule for proper specificity */
        .week-grid .slot-cell.montag {
            background: rgba(var(--calendar-yellow-rgb), 0.9);
        }

        .week-grid .slot-cell.dienstag {
            background: rgba(var(--calendar-white-rgb), 0.9);
        }

        .week-grid .slot-cell.mittwoch {
            background: rgba(var(--calendar-red-rgb), 0.9);
        }

        .week-grid .slot-cell.donnerstag {
            background: rgba(var(--calendar-red-rgb), 0.9);
        }

        .week-grid .slot-cell.freitag {
            background: rgba(var(--calendar-yellow-rgb), 0.9);
        }

        /* Day-specific hover states - moved after general hover rule for proper specificity */
        .week-grid .slot-cell.montag:hover {
            background: rgba(var(--calendar-yellow-rgb), 1.0);
        }

        .week-grid .slot-cell.dienstag:hover {
            background: rgba(var(--calendar-white-rgb), 1.0);
        }

        .week-grid .slot-cell.mittwoch:hover {
            background: rgba(var(--calendar-red-rgb), 1.0);
        }

        .week-grid .slot-cell.donnerstag:hover {
            background: rgba(var(--calendar-red-rgb), 1.0);
        }

        .week-grid .slot-cell.freitag:hover {
            background: rgba(var(--calendar-yellow-rgb), 1.0);
        }

        /* Legend color helpers */
        .legend-color.red {
            background: linear-gradient(135deg, var(--calendar-red), var(--calendar-red));
        }
        .legend-color.yellow {
            background: linear-gradient(135deg, var(--calendar-yellow), var(--calendar-yellow));
        }
        .legend-color.white {
            background: linear-gradient(135deg, var(--calendar-white), var(--calendar-white));
        }

        .slot-cell.today {
            background: rgba(118, 75, 162, 0.12);
        }

        .event-chip {
            position: absolute;
            left: 2px;
            right: 2px;
            top: 2px;
            background: linear-gradient(135deg, rgba(88, 110, 220, 0.95), rgba(104, 60, 150, 0.95));
            border: 1px solid rgba(88, 110, 220, 0.8);
            border-radius: 6px;
            padding: 4px 6px;
            font-size: 11px;
            color: white;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s ease;
            font-weight: 500;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
            z-index: 5;
        }

        .event-chip:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }

        .notes-header {
            font-size: 20px;
            font-weight: bold;
            color: #333;
            margin-bottom: 40px;
            flex-shrink: 0;
        }

        .selected-date {
            color: #667eea;
            font-weight: bold;
            margin-bottom: 10px;
            flex-shrink: 0;
        }

        .events-list {
            flex: 1;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            padding: 15px;
            background: rgba(255, 255, 255, 0.8);
            overflow-y: auto;
            min-height: 0;
        }

        .event-item {
            background: rgba(102, 126, 234, 0.1);
            border: 1px solid rgba(102, 126, 234, 0.3);
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .event-item:hover {
            background: rgba(102, 126, 234, 0.2);
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        .event-item.selected {
            background: rgba(102, 126, 234, 0.25);
            border-color: rgba(102, 126, 234, 0.5);
            transform: translateY(-1px);
        }

        .event-time {
            font-size: 12px;
            color: #666;
            margin-bottom: 5px;
        }

        .event-title {
            font-weight: bold;
            color: #333;
            font-size: 16px;
        }

        .event-description {
            font-size: 14px;
            color: #666;
            margin-top: 5px;
        }

        .no-events {
            text-align: center;
            color: #999;
            font-style: italic;
            margin-top: 50px;
        }

        .delete-button {
            background: #ff4757;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            margin-top: 8px;
            transition: background 0.2s ease;
        }

        .delete-button:hover {
            background: #ff3742;
        }

        @media (max-width: 768px) {
            .container {
                flex-direction: column;
            }
            
            .calendar-section {
                border-bottom: 1px solid rgba(255, 255, 255, 0.2);
                flex: 1.5;
            }
            
            .notes-section {
                flex: 1;
            }
            
            .week-grid {
                grid-template-columns: 60px repeat(5, 1fr);
            }
        }

        /* Chat styles */
        .notes-wrapper {
            width: 100%;
            height: calc(100vh - 142px);
            display: flex;
            justify-content: center;
            align-items: flex-start;
            padding: 20px;
            background: transparent;
        }

        .notes-card {
            width: min(1000px, 95vw);
            height: calc(100% - 40px);
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            padding: 16px;
            background: rgba(255,255,255,0.9);
            display: flex;
            flex-direction: column;
        }

        .notes-content {
            display: flex;
            flex: 1;
            gap: 16px;
            min-height: 0;
        }

        .notes-sidebar {
            width: 200px;
            flex-shrink: 0;
            border: 1px solid #e5e7eb;
            border-radius: 10px;
            background: rgba(255,255,255,0.8);
            padding: 12px;
        }

        .category-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .category-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 12px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            border: 1px solid transparent;
        }

        .category-item:hover {
            background: rgba(102, 126, 234, 0.08);
            border-color: rgba(102, 126, 234, 0.25);
        }

        .category-item.active {
            background: rgba(102, 126, 234, 0.15);
            border-color: rgba(102, 126, 234, 0.4);
            color: #333;
        }

        .category-icon {
            font-size: 16px;
        }

        .category-name {
            font-size: 14px;
            font-weight: bold;
        }

        .notes-main {
            flex: 1;
            display: flex;
            flex-direction: column;
            min-height: 0;
        }

        .notes-title {
            font-size: 24px;
            font-weight: normal;
            color: #333;
            text-align: left;
            margin-bottom: 12px;
        }

        .notes-list {
            flex: 1;
            overflow-y: auto;
            border: 1px solid #e5e7eb;
            border-radius: 10px;
            background: rgba(255,255,255,0.8);
            padding: 8px;
            min-height: 0;
        }

        .note-item {
            display: flex;
            align-items: center;
            gap: 8px;
            background: rgba(102, 126, 234, 0.08);
            border: 1px solid rgba(102, 126, 234, 0.25);
            border-radius: 8px;
            padding: 10px 12px;
            margin-bottom: 8px;
            transition: background 0.2s ease, box-shadow 0.2s ease;
        }

        .note-item:hover {
            background: rgba(102, 126, 234, 0.14);
            box-shadow: 0 2px 6px rgba(0,0,0,0.08);
        }

        .note-text {
            flex: 1;
            outline: none;
            border: none;
            background: transparent;
            font-size: 15px;
            color: #333;
            white-space: pre-wrap;
            font-weight: normal;
        }

        .note-text[contenteditable="true"]:empty:before {
            content: attr(data-placeholder);
            color: #aaa;
        }

        .note-delete {
            background: #ff4757;
            color: white;
            border: none;
            padding: 6px 10px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .note-delete:hover {
            background: #ff3742;
        }

        /* Notes specific styles */
        .notes-composer {
            display: flex;
            gap: 8px;
            align-items: flex-end;
            margin-top: 12px;
            padding: 12px;
            border: 1px solid #e5e7eb;
            border-radius: 12px;
            background: rgba(255,255,255,0.9);
        }

        .category-select {
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 6px 10px;
            background: rgba(255,255,255,0.9);
            font-size: 14px;
            color: #333;
            cursor: pointer;
            transition: border-color 0.2s ease;
        }

        .category-select:hover {
            border-color: rgba(102, 126, 234, 0.5);
        }

        .category-select:focus {
            outline: none;
            border-color: rgba(102, 126, 234, 0.8);
        }

        .note-input {
            flex: 1;
            border: none;
            outline: none;
            background: transparent;
            font-size: 14px;
            color: #333;
            padding: 8px;
            resize: vertical;
            min-height: 60px;
            font-family: inherit;
            font-weight: normal;
        }

        .note-input::placeholder {
            color: #aaa;
        }

        .add-note-button {
            width: 40px;
            height: 40px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            border-radius: 10px;
            border: 1px solid rgba(102, 126, 234, 0.35);
            background: linear-gradient(135deg, rgba(255,255,255,0.9), rgba(255,255,255,0.7));
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .add-note-button:hover {
            background: rgba(102, 126, 234, 0.12);
        }

        .note-edit {
            background: #667eea;
            color: white;
            border: none;
            padding: 6px 10px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            margin-left: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .note-edit:hover {
            background: #5a6fd8;
        }

        .note-accept {
            background: #28a745;
            color: white;
            border: none;
            padding: 6px 10px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            margin-left: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .note-accept:hover {
            background: #218838;
        }
        
        /* Chat specific components */
        .chat-card {
            padding: 20px;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            background: rgba(255, 255, 255, 0.95);
            box-shadow: 0 8px 16px rgba(0,0,0,0.06);
            display: flex;
            flex-direction: column;
            height: 100%;
        }

        .chat-header {
            font-size: 24px;
            font-weight: normal;
            color: #333;
            margin-bottom: 12px;
            flex-shrink: 0;
            text-align: center;
        }

        .chat-messages {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 10px;
            overflow-y: auto;
            padding: 10px;
            border: 1px solid #e5e7eb;
            border-radius: 10px;
            background: rgba(255,255,255,0.8);
            min-height: 0;
        }

        .chat-row {
            display: flex;
            gap: 8px;
            align-items: flex-end;
        }

        .chat-row.user { justify-content: flex-end; }
        .chat-row.assistant { justify-content: flex-start; }

        .chat-bubble {
            max-width: 80%;
            padding: 10px 12px;
            border-radius: 14px;
            font-size: 14px;
            line-height: 1.35;
            color: #222;
            background: rgba(102, 126, 234, 0.12);
            border: 1px solid rgba(102, 126, 234, 0.3);
            font-weight: normal;
        }
        .chat-row.user .chat-bubble {
            background: linear-gradient(135deg, rgba(102,126,234,0.9), rgba(118,75,162,0.9));
            color: #fff;
            border: 1px solid rgba(102,126,234,0.8);
        }

        .chat-composer {
            display: flex;
            gap: 8px;
            align-items: center;
            margin-top: 12px;
            padding: 8px;
            border: 1px solid #e5e7eb;
            border-radius: 12px;
            background: rgba(255,255,255,0.9);
        }

        .chat-input {
            flex: 1;
            border: none;
            outline: none;
            background: transparent;
            font-size: 14px;
            color: #333;
            padding: 8px;
            font-weight: normal;
            resize: vertical;
            min-height: 40px;
            font-family: inherit;
        }

        .send-button {
            width: 40px;
            height: 40px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            border-radius: 10px;
            border: 1px solid rgba(102, 126, 234, 0.35);
            background: linear-gradient(135deg, rgba(255,255,255,0.9), rgba(255,255,255,0.7));
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .send-button:hover {
            background: rgba(102, 126, 234, 0.12);
        }

        .icon { width: 18px; height: 18px; color: #333; }
        /* Modal for calendar event details */
        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.35);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .modal {
            width: min(440px, 92vw);
            background: #fff;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            box-shadow: 0 12px 28px rgba(0,0,0,0.2);
            padding: 16px;
        }

        .modal-title {
            font-size: 18px;
            font-weight: bold;
            color: #333;
            margin-bottom: 6px;
        }

        .modal-subtitle {
            font-size: 13px;
            color: #666;
            margin-bottom: 10px;
        }

        .modal-description {
            font-size: 14px;
            color: #444;
            white-space: pre-wrap;
        }

        .modal-actions {
            margin-top: 14px;
            display: flex;
            justify-content: flex-end;
            gap: 8px;
        }

        .btn-secondary {
            appearance: none;
            border: 1px solid #e0e0e0;
            background: #f8f9fb;
            color: #333;
            padding: 8px 12px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
        }

        /* Massnahmen specific styles */
        .massnahme-item {
            flex-direction: column;
            align-items: stretch;
            padding: 16px;
            margin-bottom: 12px;
            border: 1px solid #e0e0e0;
            border-radius: 12px;
            background: #fff;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }

        .massnahme-title-section {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .massnahme-title {
            font-size: 1.1em;
            font-weight: 600;
            color: #333;
            margin: 0;
        }

        .priority-badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.75em;
            font-weight: 600;
            text-transform: uppercase;
        }

        .priority-hoch {
            background: #ffebee;
            color: #c62828;
        }

        .priority-mittel {
            background: #fff3e0;
            color: #ef6c00;
        }

        .priority-niedrig {
            background: #e8f5e8;
            color: #2e7d32;
        }

        .massnahme-description {
            margin-bottom: 12px;
            line-height: 1.5;
            color: #666;
            white-space: pre-wrap;
        }

        .massnahme-actions {
            display: flex;
            gap: 8px;
            justify-content: flex-end;
        }

        .action-btn {
            background: none;
            border: 1px solid #ddd;
            padding: 6px 10px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
        }

        .action-btn:hover {
            background: #f5f5f5;
            border-color: #ccc;
        }

        .edit-btn:hover {
            background: #e3f2fd;
            border-color: #2196f3;
        }

        .accept-btn:hover {
            background: #e8f5e8;
            border-color: #4caf50;
        }

        .decline-btn:hover {
            background: #ffebee;
            border-color: #f44336;
        }

        /* Edit form styles */
        .massnahme-edit-form {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .edit-field {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .edit-field label {
            font-weight: 600;
            color: #333;
            font-size: 0.9em;
        }

        .edit-field input,
        .edit-field textarea,
        .edit-field select {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
            font-family: inherit;
        }

        .edit-field textarea {
            min-height: 80px;
            resize: vertical;
        }

        .edit-actions {
            display: flex;
            gap: 8px;
            justify-content: flex-end;
        }

        .save-btn,
        .cancel-btn {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
        }

        .save-btn {
            background: #4caf50;
            color: white;
        }

        .save-btn:hover {
            background: #45a049;
        }

        .cancel-btn {
            background: #f5f5f5;
            color: #666;
            border: 1px solid #ddd;
        }

        .cancel-btn:hover {
            background: #e0e0e0;
        }
    </style>
</head>
<body>
    <div class="top-nav">
        <div class="header-row">
            <div class="header-left">
                <img src="/assets/logo.png" alt="Logo" class="app-logo" />
            </div>
            <div class="header-center">
                <button class="nav-item active" data-view="calendar">Wochenplan</button>
                <button class="nav-item" data-view="notes">Ma√ünahmen</button>
            </div>
            <div class="header-right">
                <button class="nav-item" data-view="profile" title="Profil">
                    <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/>
                        <circle cx="12" cy="7" r="4"/>
                    </svg>
                </button>
                <button class="burger" aria-label="Men√º" title="Men√º">
                    <span class="bar"></span>
                </button>
            </div>
        </div>
    </div>

    <div id="view-calendar" class="view active">
        <div class="container">
            <div class="calendar-section">
                <div class="calendar-actions">
                    <button id="calendarExportBtn" class="nav-item" title="Export">Exportieren</button>
                </div>
                <div class="calendar-header">
                    <div class="week-year" id="weekYear"></div>
                    <div class="calendar-legend">
                        <div class="legend-item">
                            <div class="legend-color red"></div>
                            <span class="legend-text">Pr√§senztage</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color yellow"></div>
                            <span class="legend-text">Flextage</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color white"></div>
                            <span class="legend-text">Home Office</span>
                        </div>
                    </div>
                </div>
                <div class="week-grid" id="weekGrid"></div>
            </div>
            
            <div class="notes-section">
                <div class="chat-card">
                    <div class="chat-header">KI Chat</div>
                    <div class="chat-messages" id="chatMessages"></div>
                    <div class="chat-composer">
                        <textarea id="chatInput" class="chat-input" placeholder="Nachricht an KI senden..." rows="1"></textarea>
                        <button id="chatSend" class="send-button" title="Senden" aria-label="Senden">
                            <svg id="micIcon" class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M12 1a3 3 0 0 0-3 3v7a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"/>
                                <path d="M19 10v2a7 7 0 0 1-14 0v-2"/>
                                <line x1="12" y1="19" x2="12" y2="23"/>
                                <line x1="8" y1="23" x2="16" y2="23"/>
                            </svg>
                            <svg id="sendIcon" class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="display:none;">
                                <line x1="22" y1="2" x2="11" y2="13"/>
                                <polygon points="22 2 15 22 11 13 2 9 22 2"/>
                            </svg>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="view-notes" class="view">
        <div class="notes-wrapper">
            <div class="notes-card">
                <div class="notes-title"><strong>Hallo Carina</strong>, hier sind deine Team-Ma√ünahmen</div>
                <div class="notes-content">
                    <div class="notes-sidebar">
                        <div class="category-list">
                            <div class="category-item active" data-category="einmalige_massnahmen">
                                <span class="category-icon">üë•</span>
                                <span class="category-name">Team-Ma√ünahmen</span>
                            </div>
                            <div class="category-item" data-category="arbeitsplatz">
                                <span class="category-icon">üè¢</span>
                                <span class="category-name">Arbeitsplatz</span>
                            </div>
                            <div class="category-item" data-category="work_life_balance">
                                <span class="category-icon">‚öñÔ∏è</span>
                                <span class="category-name">Work Life Balance</span>
                            </div>
                        </div>
                    </div>
                    <div class="notes-main">
                        <div class="notes-list" id="notesList"></div>
                        <div class="notes-composer">
                            <textarea id="noteInput" class="note-input" placeholder="F√ºge eine Ma√ünahme hinzu..." rows="3"></textarea>
                            <button id="addNoteBtn" class="add-note-button" title="Add Ma√ünahme" aria-label="Add Ma√ünahme">
                                <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <line x1="12" y1="5" x2="12" y2="19"/>
                                    <line x1="5" y1="12" x2="19" y2="12"/>
                                </svg>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="view-export" class="view">
        <div class="container" style="justify-content:center; align-items:center;">
            <div class="card" style="padding: 24px; text-align: center;">
                <div style="font-size: 22px; font-weight: 700; color: #333;">Exportieren <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M6 9l6 6 6-6"/></svg></div>
                <div style="margin-top: 8px; color:#666;">Dieser Bereich ist bald verf√ºgbar.</div>
            </div>
        </div>
    </div>

    <div id="view-profile" class="view">
        <div class="container" style="justify-content:center; align-items:center;">
            <div class="card" style="padding: 24px; text-align: center;">
                <div style="font-size: 22px; font-weight: 700; color: #333;">Profil</div>
                <div style="margin-top: 8px; color:#666;">Dieser Bereich ist bald verf√ºgbar.</div>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = 'http://127.0.0.1:8000';
        let selectedDay = null;
        let selectedEventIndex = null;
        let events = {};

        const dayNames = ["Montag", "Dienstag", "Mittwoch", "Donnerstag", "Freitag"];


        function formatDayKey(dayIndex) {
            return dayNames[dayIndex];
        }

        function formatDisplayDay(dayIndex) {
            return dayNames[dayIndex];
        }

        function getWeekDays() {
            return dayNames.map((day, index) => ({ name: day, index }));
        }

        function renderCalendar() {
            const weekYear = document.getElementById('weekYear');
            const weekGrid = document.getElementById('weekGrid');

            const weekDays = getWeekDays();

            weekYear.innerHTML = '<strong>Hallo Carina</strong>, hier ist dein Wochenplan';
            weekGrid.innerHTML = '';

            // Top-left empty header
            const emptyHeader = document.createElement('div');
            emptyHeader.className = 'header';
            emptyHeader.textContent = '';
            weekGrid.appendChild(emptyHeader);

            // Day headers Monday..Friday
            weekDays.forEach((day) => {
                const header = document.createElement('div');
                header.className = `header ${day.name.toLowerCase()}`;
                header.textContent = day.name;
                weekGrid.appendChild(header);
            });

            // Create time slots from 06:00 to 20:00
            const startHour = 6;
            const endHour = 20;
            
            for (let hour = startHour; hour <= endHour; hour++) {
                // Time column
                const timeCell = document.createElement('div');
                timeCell.className = 'time-cell';
                const label24 = `${String(hour).padStart(2, '0')}:00`;
                timeCell.textContent = label24;
                weekGrid.appendChild(timeCell);

                // 5 day columns for this hour
                weekDays.forEach((day) => {
                    const slot = document.createElement('div');
                    slot.className = `slot-cell ${day.name.toLowerCase()}`;
                    slot.dataset.day = day.index;
                    slot.dataset.hour = String(hour);

                    // Check if this is the start of an event
                    const dayKey = formatDayKey(day.index);
                    const dayEvents = events[dayKey] || [];
                    const eventAtThisHour = dayEvents.find(ev => Number(ev.hour) === hour);
                    
                    if (eventAtThisHour) {
                        const chip = document.createElement('div');
                        chip.className = 'event-chip';
                        chip.textContent = eventAtThisHour.title || 'Ereignis';
                        chip.title = eventAtThisHour.description ? 
                            `${eventAtThisHour.title} ‚Äî ${eventAtThisHour.description} (${eventAtThisHour.duration || 1}h)` : 
                            `${eventAtThisHour.title} (${eventAtThisHour.duration || 1}h)`;
                        
                        // Style based on duration - span multiple cells
                        const duration = eventAtThisHour.duration || 1;
                        chip.style.height = `${(duration * 40) - 2}px`;
                        
                        // Click event to select this event in notes section
                        chip.addEventListener('click', (e) => {
                            e.stopPropagation();
                            selectEvent(day.index, dayEvents.indexOf(eventAtThisHour));
                        });
                        
                        slot.appendChild(chip);
                    }

                    // Empty slot click to add new event
                    if (!eventAtThisHour) {
                        slot.addEventListener('click', () => onSlotClick(day.index, hour));
                    }
                    
                    weekGrid.appendChild(slot);
                });
            }
        }

        function selectDay(dayIndex) {
            selectedDay = dayIndex;
            selectedEventIndex = null;
            const selectedDateElement = document.getElementById('selectedDate');
            const eventsList = document.getElementById('eventsList');
            // Gracefully handle when the side panel is not present
            if (!selectedDateElement || !eventsList) {
                return;
            }
            
            selectedDateElement.textContent = formatDisplayDay(dayIndex);
            
            // Load events for selected day
            const dayKey = formatDayKey(dayIndex);
            const dayEvents = events[dayKey] || [];
            
            eventsList.innerHTML = '';
            
            if (dayEvents.length === 0) {
                const noEvents = document.createElement('div');
                noEvents.className = 'no-events';
                noEvents.textContent = 'Keine Ereignisse f√ºr diesen Tag. Klicken Sie auf einen Zeitbereich, um ein Ereignis hinzuzuf√ºgen.';
                eventsList.appendChild(noEvents);
            } else {
                const withIndex = dayEvents.map((ev, originalIndex) => ({ ev, originalIndex }));
                withIndex.sort((a, b) => Number(a.ev.hour) - Number(b.ev.hour));
                withIndex.forEach(({ ev: event, originalIndex }, index) => {
                    const eventElement = document.createElement('div');
                    eventElement.className = 'event-item';
                    if (selectedEventIndex === index) {
                        eventElement.classList.add('selected');
                    }
                    
                    const hour = Number(event.hour);
                    const duration = event.duration || 1;
                    const ampm = `${String(hour).padStart(2, '0')}:00`;
                    const endHour = hour + duration;
                    const endAmpm = `${String(endHour).padStart(2, '0')}:00`;
                    
                    eventElement.innerHTML = `
                        <div class="event-time">${ampm} - ${endAmpm} (${duration}h)</div>
                        <div class="event-title">${event.title}</div>
                        ${event.description ? `<div class="event-description">${event.description}</div>` : ''}
                    `;
                    
                    eventElement.addEventListener('click', () => {
                        selectedEventIndex = index;
                        selectDay(selectedDay); // Refresh to show selection
                    });
                    
                    eventsList.appendChild(eventElement);
                });
            }
        }

        function selectEvent(dayIndex, eventIndex) {
            selectedDay = dayIndex;
            selectedEventIndex = eventIndex;
            openEventModal(dayIndex, eventIndex);
        }

        async function deleteEvent(eventIndex) {
            if (!confirm('Dieses Ereignis l√∂schen?')) return;
            const dayKey = formatDayKey(selectedDay);
            try {
                const res = await fetch(`${API_BASE}/events?day=${encodeURIComponent(dayKey)}&index=${encodeURIComponent(eventIndex)}`, {
                    method: 'DELETE',
                    headers: { 'Content-Type': 'application/json' },
                });
                if (!res.ok) {
                    const err = await res.json().catch(() => ({}));
                    alert(err.detail || 'Fehler beim L√∂schen des Ereignisses');
                    return;
                }
                const data = await res.json();
                events = data.events || {};
                selectedEventIndex = null;
                // Always re-render the calendar grid
                renderCalendar();
                // Update the optional side panel if it exists
                try {
                    selectDay(selectedDay);
                } catch (_) {
                    // Ignore UI panel update errors
                }
            } catch (e) {
                alert('Could not reach backend. Is it running on 127.0.0.1:8000?');
            }
        }

        async function onSlotClick(dayIndex, hour) {
            selectedDay = dayIndex;
            const title = prompt('Ereignistitel:');
            if (!title) return;
            const description = prompt('Beschreibung (optional):');
            const durationInput = prompt('Dauer in Stunden (Standard: 1):'); 
            const duration = durationInput ? parseInt(durationInput) || 1 : 1;

            // Validate that the event fits within the 6am-8pm range
            const startHour = 6;
            const endHour = 20;
            if (hour < startHour || hour + duration > endHour + 1) {
                alert(`Das Ereignis muss zwischen ${startHour} und ${endHour} liegen.`);
                return;
            }

            // Check for overlapping events
            const key = formatDayKey(dayIndex);
            const dayEvents = events[key] || [];
            const hasOverlap = dayEvents.some(existingEvent => {
                const existingStart = Number(existingEvent.hour);
                const existingEnd = existingStart + (existingEvent.duration || 1);
                const newStart = hour;
                const newEnd = hour + duration;
                
                return (newStart < existingEnd && newEnd > existingStart);
            });

            if (hasOverlap) {
                alert('Dieser Zeitbereich √ºberschneidet sich mit einem existierenden Ereignis. Bitte w√§hlen Sie einen anderen Zeitbereich.');
                return;
            }

            try {
                const res = await fetch(`${API_BASE}/events`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        day: key,
                        event: { title, description: description || '', hour: Number(hour), duration }
                    })
                });
                if (!res.ok) {
                    const err = await res.json().catch(() => ({}));
                    alert(err.detail || 'Fehler beim Hinzuf√ºgen des Ereignisses');
                    return;
                }
                const data = await res.json();
                events = data.events || {};
                renderCalendar();
                selectDay(selectedDay);
            } catch (e) {
                alert('Konnte nicht mit dem Backend kommunizieren. L√§uft es auf 127.0.0.1:8000?');
            }
        }

        async function loadEvents() {
            try {
                const res = await fetch(`${API_BASE}/events`);
                if (!res.ok) {
                    throw new Error('Fehler beim Laden der Ereignisse');
                }
                const data = await res.json();
                events = data.events || {};
            } catch (e) {
                // Keep empty events but notify user once
                console.warn('Konnte nicht mit dem Backend kommunizieren:', e);
            }
        }

        // Simple view switching
        function switchView(viewName) {
            const views = document.querySelectorAll('.view');
            views.forEach(v => v.classList.remove('active'));
            const target = document.getElementById(`view-${viewName}`);
            if (target) target.classList.add('active');

            const tabs = document.querySelectorAll('.nav-item');
            tabs.forEach(t => t.classList.remove('active'));
            const activeTab = document.querySelector(`.nav-item[data-view="${viewName}"]`);
            if (activeTab) activeTab.classList.add('active');

            // Greeting removed from header; no dynamic greeting updates needed

            if (viewName === 'calendar') {
                renderCalendar();
                if (selectedDay !== null) selectDay(selectedDay);
            } else if (viewName === 'notes') {
                initNotesView();
            }
        }

        document.querySelectorAll('.nav-item').forEach(btn => {
            btn.addEventListener('click', () => switchView(btn.dataset.view));
        });

        // Initialize calendar with backend data
        (async () => {
            await loadEvents();
            renderCalendar();
        })();

        // Make calendar responsive to window resize
        window.addEventListener('resize', () => {
            renderCalendar();
            if (selectedDay !== null) selectDay(selectedDay);
        });

        // Notes logic
        let notes = [];
        let editingNoteId = null;
        let selectedCategory = 'einmalige_massnahmen';
        
        // Massnahmen logic
        let massnahmen = { einmalige_massnahmen: [], arbeitsplatz: [], work_life_balance: [] };

        async function loadMassnahmen() {
            try {
                const res = await fetch(`${API_BASE}/massnahmen`);
                if (!res.ok) throw new Error('Fehler beim Laden der Ma√ünahmen');
                const data = await res.json();
                massnahmen = {
                    einmalige_massnahmen: data.einmalige_massnahmen || [],
                    arbeitsplatz: data.arbeitsplatz || [],
                    work_life_balance: data.work_life_balance || []
                };
                renderMassnahmen();
            } catch (e) {
                console.warn('Could not load massnahmen from backend:', e);
                massnahmen = { einmalige_massnahmen: [], arbeitsplatz: [], work_life_balance: [] };
                renderMassnahmen();
            }
        }

        function renderMassnahmen() {
            const container = document.getElementById('notesList');
            if (!container) return;
            
            container.innerHTML = '';
            
            // Get massnahmen for selected category
            const categoryMassnahmen = massnahmen[selectedCategory] || [];
            
            if (categoryMassnahmen.length === 0) {
                const emptyMsg = document.createElement('div');
                emptyMsg.className = 'no-events';
                emptyMsg.textContent = `Noch keine ${selectedCategory} Ma√ünahmen. F√ºge unten eine neue hinzu.`;
                container.appendChild(emptyMsg);
                // Continue to show composer for creating new ones
            }

            categoryMassnahmen.forEach((massnahme, index) => {
                const massnahmeElement = document.createElement('div');
                massnahmeElement.className = 'note-item massnahme-item';
                massnahmeElement.dataset.index = index;
                
                // Title section
                const titleSection = document.createElement('div');
                titleSection.className = 'massnahme-title-section';
                
                const titleElement = document.createElement('div');
                titleElement.className = 'note-title massnahme-title';
                titleElement.textContent = massnahme.title;
                
                // Priority badge
                const priorityElement = document.createElement('div');
                priorityElement.className = `priority-badge priority-${massnahme.priority}`;
                priorityElement.textContent = massnahme.priority.toUpperCase();
                
                titleSection.appendChild(titleElement);
                titleSection.appendChild(priorityElement);
                
                // Description section with better spacing
                const descriptionElement = document.createElement('div');
                descriptionElement.className = 'note-text massnahme-description';
                descriptionElement.textContent = massnahme.description;
                
                // Action buttons
                const actionsElement = document.createElement('div');
                actionsElement.className = 'massnahme-actions';
                
                const editBtn = document.createElement('button');
                editBtn.className = 'action-btn edit-btn';
                editBtn.innerHTML = '‚úèÔ∏è';
                editBtn.title = 'Bearbeiten';
                editBtn.onclick = () => editMassnahme(index);
                
                const acceptBtn = document.createElement('button');
                acceptBtn.className = 'action-btn accept-btn';
                acceptBtn.innerHTML = '‚úÖ';
                acceptBtn.title = 'Akzeptieren';
                acceptBtn.onclick = () => acceptMassnahme(index);
                
                const declineBtn = document.createElement('button');
                declineBtn.className = 'action-btn decline-btn';
                declineBtn.innerHTML = '‚ùå';
                declineBtn.title = 'Ablehnen';
                declineBtn.onclick = () => declineMassnahme(index);
                
                actionsElement.appendChild(editBtn);
                actionsElement.appendChild(acceptBtn);
                actionsElement.appendChild(declineBtn);
                
                massnahmeElement.appendChild(titleSection);
                massnahmeElement.appendChild(descriptionElement);
                massnahmeElement.appendChild(actionsElement);
                
                container.appendChild(massnahmeElement);
            });
        }

        // Massnahmen action functions
        function editMassnahme(index) {
            const categoryMassnahmen = massnahmen[selectedCategory] || [];
            const massnahme = categoryMassnahmen[index];
            if (!massnahme) return;

            const massnahmeElement = document.querySelector(`[data-index="${index}"]`);
            if (!massnahmeElement) return;

            // Create edit form
            const editForm = document.createElement('div');
            editForm.className = 'massnahme-edit-form';
            editForm.innerHTML = `
                <div class="edit-field">
                    <label>Titel:</label>
                    <input type="text" class="edit-title" value="${massnahme.title}" />
                </div>
                <div class="edit-field">
                    <label>Beschreibung:</label>
                    <textarea class="edit-description">${massnahme.description}</textarea>
                </div>
                <div class="edit-field">
                    <label>Priorit√§t:</label>
                    <select class="edit-priority">
                        <option value="hoch" ${massnahme.priority === 'hoch' ? 'selected' : ''}>Hoch</option>
                        <option value="mittel" ${massnahme.priority === 'mittel' ? 'selected' : ''}>Mittel</option>
                        <option value="niedrig" ${massnahme.priority === 'niedrig' ? 'selected' : ''}>Niedrig</option>
                    </select>
                </div>
                <div class="edit-actions">
                    <button class="save-btn" onclick="saveMassnahme(${index})">Speichern</button>
                    <button class="cancel-btn" onclick="cancelEditMassnahme(${index})">Abbrechen</button>
                </div>
            `;

            // Replace content with edit form
            massnahmeElement.innerHTML = '';
            massnahmeElement.appendChild(editForm);
        }

        async function saveMassnahme(index) {
            const massnahmeElement = document.querySelector(`[data-index="${index}"]`);
            if (!massnahmeElement) return;

            const titleInput = massnahmeElement.querySelector('.edit-title');
            const descriptionInput = massnahmeElement.querySelector('.edit-description');
            const prioritySelect = massnahmeElement.querySelector('.edit-priority');

            const updatedMassnahme = {
                title: titleInput.value.trim(),
                description: descriptionInput.value.trim(),
                priority: prioritySelect.value
            };

            if (!updatedMassnahme.title) {
                alert('Titel ist erforderlich');
                return;
            }

            try {
                const res = await fetch(`${API_BASE}/massnahmen/${selectedCategory}/${index}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(updatedMassnahme)
                });

                if (!res.ok) throw new Error('Fehler beim Aktualisieren der Ma√ünahme');

                const data = await res.json();
                massnahmen = {
                    einmalige_massnahmen: data.einmalige_massnahmen || [],
                    arbeitsplatz: data.arbeitsplatz || [],
                    work_life_balance: data.work_life_balance || []
                };
                renderMassnahmen();
            } catch (e) {
                console.error('Error updating massnahme:', e);
                alert('Aktualisieren der Ma√ünahme fehlgeschlagen');
            }
        }

        function cancelEditMassnahme(index) {
            renderMassnahmen();
        }

        async function acceptMassnahme(index) {
            if (confirm('Ist diese Ma√ünahme umgesetzt worden?')) {
                // For now, we'll just remove it from the list
                // In a real app, you might want to move it to an "accepted" category
                await deleteMassnahme(index);
            }
        }

        async function declineMassnahme(index) {
            await deleteMassnahme(index);
        }

        async function deleteMassnahme(index) {
            try {
                const res = await fetch(`${API_BASE}/massnahmen/${selectedCategory}/${index}`, {
                    method: 'DELETE'
                });

                if (!res.ok) throw new Error('Fehler beim L√∂schen der Ma√ünahme');

                const data = await res.json();
                massnahmen = {
                    einmalige_massnahmen: data.einmalige_massnahmen || [],
                    arbeitsplatz: data.arbeitsplatz || [],
                    work_life_balance: data.work_life_balance || []
                };
                renderMassnahmen();
            } catch (e) {
                console.error('Error deleting massnahme:', e);
                alert('L√∂schen der Ma√ünahme fehlgeschlagen');
            }
        }

        async function loadNotes() {
            try {
                const res = await fetch(`${API_BASE}/notes`);
                if (!res.ok) throw new Error('Fehler beim Laden der Notizen');
                const data = await res.json();
                notes = data.notes || [];
                renderNotes();
            } catch (e) {
                console.warn('Could not load notes from backend:', e);
                notes = [];
                renderNotes();
            }
        }

        async function addNote(text, category) {
            if (!text.trim()) return;
            try {
                const res = await fetch(`${API_BASE}/notes`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ text: text.trim(), category: category || 'einmalige_massnahmen' })
                });
                if (!res.ok) throw new Error('Fehler beim Hinzuf√ºgen der Notiz');
                const data = await res.json();
                notes = data.notes || [];
                renderNotes();
            } catch (e) {
                console.error('Could not add note:', e);
                alert('Could not add note. Is the backend running?');
            }
        }

        async function updateNote(noteId, text, category) {
            try {
                const res = await fetch(`${API_BASE}/notes/${noteId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ text: text.trim(), category: category || 'einmalige_massnahmen' })
                });
                if (!res.ok) throw new Error('Fehler beim Aktualisieren der Notiz');
                const data = await res.json();
                notes = data.notes || [];
                renderNotes();
            } catch (e) {
                console.error('Could not update note:', e);
                alert('Could not update note. Is the backend running?');
            }
        }

        async function deleteNote(noteId) {
            if (!confirm('Diese Notiz l√∂schen?')) return;
            try {
                const res = await fetch(`${API_BASE}/notes/${noteId}`, {
                    method: 'DELETE'
                });
                if (!res.ok) throw new Error('Fehler beim L√∂schen der Notiz');
                const data = await res.json();
                notes = data.notes || [];
                renderNotes();
            } catch (e) {
                console.error('Could not delete note:', e);
                alert('Could not delete note. Is the backend running?');
            }
        }

        function renderNotes() {
            const container = document.getElementById('notesList');
            if (!container) return;
            
            container.innerHTML = '';
            
            // Filter notes by selected category
            const filteredNotes = notes.filter(note => note.category === selectedCategory);
            
            if (filteredNotes.length === 0) {
                const emptyMsg = document.createElement('div');
                emptyMsg.className = 'no-events';
                emptyMsg.textContent = `Noch keine Notizen in ${selectedCategory}. F√ºge unten deine erste Notiz hinzu.`;
                container.appendChild(emptyMsg);
                return;
            }

            filteredNotes.forEach(note => {
                const noteElement = document.createElement('div');
                noteElement.className = 'note-item';
                
                if (editingNoteId === note.id) {
                    // Edit mode
                    const editContainer = document.createElement('div');
                    editContainer.style.display = 'flex';
                    editContainer.style.flexDirection = 'column';
                    editContainer.style.gap = '8px';
                    
                    const categorySelect = document.createElement('select');
                    categorySelect.className = 'category-select';
                    categorySelect.style.width = 'fit-content';
                    categorySelect.innerHTML = `
                        <option value="einmalige_massnahmen" ${note.category === 'einmalige_massnahmen' ? 'selected' : ''}>‚ö° Einmalige Ma√ünahmen</option>
                        <option value="arbeitsplatz" ${note.category === 'arbeitsplatz' ? 'selected' : ''}>üè¢ Arbeitsplatz</option>
                        <option value="work_life_balance" ${note.category === 'work_life_balance' ? 'selected' : ''}>‚öñÔ∏è Work life balance</option>
                    `;
                    
                    const textarea = document.createElement('textarea');
                    textarea.className = 'note-text';
                    textarea.value = note.text;
                    textarea.rows = 3;
                    
                    const buttonContainer = document.createElement('div');
                    buttonContainer.style.display = 'flex';
                    buttonContainer.style.gap = '8px';
                    
                    const saveBtn = document.createElement('button');
                    saveBtn.className = 'note-edit';
                    saveBtn.textContent = 'Speichern';
                    saveBtn.onclick = () => {
                        updateNote(note.id, textarea.value, categorySelect.value);
                        editingNoteId = null;
                    };
                    
                    const cancelBtn = document.createElement('button');
                    cancelBtn.className = 'note-delete';
                    cancelBtn.textContent = 'Abbrechen';
                    cancelBtn.onclick = () => {
                        editingNoteId = null;
                        renderNotes();
                    };
                    
                    buttonContainer.appendChild(saveBtn);
                    buttonContainer.appendChild(cancelBtn);
                    
                    editContainer.appendChild(categorySelect);
                    editContainer.appendChild(textarea);
                    editContainer.appendChild(buttonContainer);
                    
                    noteElement.appendChild(editContainer);
                } else {
                    // View mode
                    const textSpan = document.createElement('span');
                    textSpan.className = 'note-text';
                    textSpan.textContent = note.text;
                    
                    const editBtn = document.createElement('button');
                    editBtn.className = 'note-edit';
                    editBtn.innerHTML = '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>';
                    editBtn.title = 'Bearbeiten';
                    editBtn.onclick = () => {
                        editingNoteId = note.id;
                        renderNotes();
                    };
                    
                    const acceptBtn = document.createElement('button');
                    acceptBtn.className = 'note-accept';
                    acceptBtn.innerHTML = '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="20,6 9,17 4,12"/></svg>';
                    acceptBtn.title = 'Akzeptieren';
                    acceptBtn.onclick = () => {
                        // Add accept functionality here
                        console.log('Accept note:', note.id);
                    };
                    
                    const declineBtn = document.createElement('button');
                    declineBtn.className = 'note-delete';
                    declineBtn.innerHTML = '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>';
                    declineBtn.title = 'Ablehnen';
                    declineBtn.onclick = () => deleteNote(note.id);
                    
                    noteElement.appendChild(textSpan);
                    noteElement.appendChild(editBtn);
                    noteElement.appendChild(acceptBtn);
                    noteElement.appendChild(declineBtn);
                }
                
                container.appendChild(noteElement);
            });
        }

        function switchCategory(category) {
            selectedCategory = category;
            
            // Update active category in sidebar
            document.querySelectorAll('.category-item').forEach(item => {
                item.classList.remove('active');
            });
            document.querySelector(`[data-category="${category}"]`).classList.add('active');
            
            // Re-render based on whether we have massnahmen data or notes
            if (massnahmen.einmalige_massnahmen.length > 0 || massnahmen.arbeitsplatz.length > 0 || massnahmen.work_life_balance.length > 0) {
                renderMassnahmen();
            } else {
                renderNotes();
            }
        }

        function initNotesView() {
            loadNotes();
            loadMassnahmen();
            
            // Set up category switching
            document.querySelectorAll('.category-item').forEach(item => {
                item.addEventListener('click', () => {
                    const category = item.dataset.category;
                    switchCategory(category);
                });
            });
            
            const noteInput = document.getElementById('noteInput');
            const addBtn = document.getElementById('addNoteBtn');
            
            if (noteInput && addBtn) {
                addBtn.onclick = () => openCreateMassnahmeForm(noteInput.value.trim());
                noteInput.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter' && e.ctrlKey) {
                        e.preventDefault();
                        openCreateMassnahmeForm(noteInput.value.trim());
                    }
                });
            }
        }

        // Create new Massnahme using same edit UI
        function openCreateMassnahmeForm(prefillText) {
            const container = document.getElementById('notesList');
            if (!container) return;
            // Insert form at top
            const formWrapper = document.createElement('div');
            formWrapper.className = 'note-item massnahme-item';
            const defaultTitle = prefillText ? prefillText : '';
            formWrapper.innerHTML = `
                <div class="massnahme-edit-form">
                    <div class="edit-field">
                        <label>Titel:</label>
                        <input type="text" class="edit-title" value="${defaultTitle}" />
                    </div>
                    <div class="edit-field">
                        <label>Beschreibung:</label>
                        <textarea class="edit-description"></textarea>
                    </div>
                    <div class="edit-field">
                        <label>Priorit√§t:</label>
                        <select class="edit-priority">
                            <option value="hoch">Hoch</option>
                            <option value="mittel" selected>Mittel</option>
                            <option value="niedrig">Niedrig</option>
                        </select>
                    </div>
                    <div class="edit-actions">
                        <button class="save-btn" id="createMassnahmeSave">Hinzuf√ºgen</button>
                        <button class="cancel-btn" id="createMassnahmeCancel">Abbrechen</button>
                    </div>
                </div>
            `;
            container.prepend(formWrapper);

            const noteInput = document.getElementById('noteInput');
            if (noteInput) noteInput.value = '';

            function collectNew() {
                const title = formWrapper.querySelector('.edit-title').value.trim();
                const description = formWrapper.querySelector('.edit-description').value.trim();
                const priority = formWrapper.querySelector('.edit-priority').value;
                return { title, description, priority };
            }

            async function saveNew() {
                const newItem = collectNew();
                if (!newItem.title) { alert('Titel ist erforderlich'); return; }
                try {
                    const res = await fetch(`${API_BASE}/massnahmen/${selectedCategory}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(newItem)
                    });
                    if (!res.ok) throw new Error('Fehler beim Erstellen der Ma√ünahme');
                    const data = await res.json();
                    massnahmen = {
                        einmalige_massnahmen: data.einmalige_massnahmen || [],
                        arbeitsplatz: data.arbeitsplatz || [],
                        work_life_balance: data.work_life_balance || []
                    };
                    renderMassnahmen();
                } catch (e) {
                    console.error('Error creating massnahme:', e);
                    alert('Erstellen der Ma√ünahme fehlgeschlagen');
                }
            }

            formWrapper.querySelector('#createMassnahmeSave').addEventListener('click', saveNew);
            formWrapper.querySelector('#createMassnahmeCancel').addEventListener('click', () => {
                renderMassnahmen();
            });
        }

        // Initialize notes and massnahmen when page loads
        (async () => {
            await loadNotes();
            await loadMassnahmen();
        })();

        // Chat logic for calendar sidebar (frontend-only placeholder storage)
        const CHAT_STORAGE_KEY = 'chat_messages_v1';
        function loadChatMessages() {
            try {
                const raw = localStorage.getItem(CHAT_STORAGE_KEY) || '[]';
                const parsed = JSON.parse(raw);
                const messages = Array.isArray(parsed) ? parsed : [];
                
                // Ensure there's always a welcome message from AI as the first entry
                if (messages.length === 0 || messages[0].role !== 'assistant') {
                    const welcomeMessage = { role: 'assistant', text: 'Guten Abend Carina, wie kann ich dir weiterhelfen?' };
                    messages.unshift(welcomeMessage);
                    saveChatMessages(messages);
                }
                
                return messages;
            } catch { 
                // If there's an error, return just the welcome message
                const welcomeMessage = [{ role: 'assistant', text: 'Guten Abend Carina, wie kann ich dir weiterhelfen?' }];
                saveChatMessages(welcomeMessage);
                return welcomeMessage;
            }
        }
        function saveChatMessages(msgs) {
            localStorage.setItem(CHAT_STORAGE_KEY, JSON.stringify(msgs));
        }
        async function fetchChatFromBackend() {
            try {
                const res = await fetch(`${API_BASE}/chat`);
                if (!res.ok) return null;
                const data = await res.json();
                if (!data || !Array.isArray(data.messages)) return null;
                
                // Ensure there's always a welcome message from AI as the first entry
                const messages = data.messages;
                if (messages.length === 0 || messages[0].role !== 'assistant') {
                    const welcomeMessage = { role: 'assistant', text: 'Guten Abend Carina, wie kann ich dir weiterhelfen?' };
                    messages.unshift(welcomeMessage);
                }
                
                return messages;
            } catch { return null; }
        }
        async function postChatToBackend(message) {
            try {
                await fetch(`${API_BASE}/chat`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ role: 'user', text: message })
                });
            } catch { /* ignore network errors, localStorage is primary */ }
        }
        function renderChatMessages(containerId, messages) {
            const container = document.getElementById(containerId);
            if (!container) return;
            container.innerHTML = '';
            messages.forEach(m => {
                const row = document.createElement('div');
                row.className = `chat-row ${m.role}`;
                const bubble = document.createElement('div');
                bubble.className = 'chat-bubble';
                bubble.textContent = m.text;
                row.appendChild(bubble);
                container.appendChild(row);
            });
            container.scrollTop = container.scrollHeight;
        }
        function hookupComposer(inputId, sendBtnId, micIconId, sendIconId, renderTargetId) {
            const input = document.getElementById(inputId);
            const btn = document.getElementById(sendBtnId);
            const mic = document.getElementById(micIconId);
            const send = document.getElementById(sendIconId);
            if (!input || !btn || !mic || !send) return;
            function updateIcons() {
                const hasText = input.value.trim().length > 0;
                mic.style.display = hasText ? 'none' : 'block';
                send.style.display = hasText ? 'block' : 'none';
            }
            input.addEventListener('input', updateIcons);
            async function submit() {
                const text = input.value.trim();
                if (!text) return;
                
                // Add user message immediately for better UX
                const messages = loadChatMessages();
                messages.push({ role: 'user', text });
                saveChatMessages(messages);
                renderChatMessages(renderTargetId, messages);
                
                // Get AI response from backend
                try {
                    const res = await fetch(`${API_BASE}/chat`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ role: 'user', text })
                    });
                    
                    if (res.ok) {
                        const data = await res.json();
                        const updatedMessages = data.messages || [];
                        // Ensure the initial assistant welcome message is persistent
                        if (updatedMessages.length === 0 || updatedMessages[0].role !== 'assistant') {
                            updatedMessages.unshift({ role: 'assistant', text: 'Guten Abend Carina, wie kann ich dir weiterhelfen?' });
                        }
                        saveChatMessages(updatedMessages);
                        renderChatMessages(renderTargetId, updatedMessages);
                    } else {
                        // Fallback: add error message
                        messages.push({ role: 'assistant', text: 'Entschuldigung, es ist ein Fehler aufgetreten. Bitte versuche es erneut.' });
                        saveChatMessages(messages);
                        renderChatMessages(renderTargetId, messages);
                    }
                } catch (error) {
                    // Fallback: add error message
                    messages.push({ role: 'assistant', text: 'Entschuldigung, ich kann keine Verbindung zum KI-Dienst herstellen. Bitte pr√ºfe, ob das Backend l√§uft.' });
                    saveChatMessages(messages);
                    renderChatMessages(renderTargetId, messages);
                }
                
                input.value = '';
                updateIcons();
            }
            btn.addEventListener('click', submit);
            input.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    submit();
                }
            });
            updateIcons();
        }

        // Initialize chat in the calendar sidebar
        hookupComposer('chatInput','chatSend','micIcon','sendIcon','chatMessages');
        (async () => {
            const localMsgs = loadChatMessages();
            renderChatMessages('chatMessages', localMsgs);
            const backendMsgs = await fetchChatFromBackend();
            if (backendMsgs) {
                saveChatMessages(backendMsgs);
                renderChatMessages('chatMessages', backendMsgs);
            }
        })();

        // Export button inside calendar
        const calendarExportBtn = document.getElementById('calendarExportBtn');
        if (calendarExportBtn) {
            calendarExportBtn.addEventListener('click', () => switchView('export'));
        }

        // Modal structure
        const modalOverlay = document.createElement('div');
        modalOverlay.className = 'modal-overlay';
        modalOverlay.innerHTML = `
            <div class="modal" role="dialog" aria-modal="true">
                <div class="modal-title" id="modalTitle"></div>
                <div class="modal-subtitle" id="modalTime"></div>
                <div class="modal-description" id="modalDescription"></div>
                <div class="modal-actions">
                    <button class="btn-secondary" id="closeModalBtn">Schlie√üen</button>
                    <button class="delete-button" id="deleteEventBtn">L√∂schen</button>
                </div>
            </div>`;
        document.body.appendChild(modalOverlay);

        let modalCtx = { dayIndex: null, eventIndex: null };

        function openEventModal(dayIndex, eventIndex) {
            const dayKey = formatDayKey(dayIndex);
            const dayEvents = events[dayKey] || [];
            const ev = dayEvents[eventIndex];
            if (!ev) return;

            const hour = Number(ev.hour);
            const duration = ev.duration || 1;
            const start = `${String(hour).padStart(2,'0')}:00`;
            const end = `${String(hour + duration).padStart(2,'0')}:00`;

            document.getElementById('modalTitle').textContent = ev.title || 'Ereignis';
            document.getElementById('modalTime').textContent = `${formatDisplayDay(dayIndex)} ‚Ä¢ ${start} - ${end} (${duration}h)`;
            document.getElementById('modalDescription').textContent = ev.description || '';

            modalCtx = { dayIndex, eventIndex };
            modalOverlay.style.display = 'flex';
        }

        function closeEventModal() {
            modalOverlay.style.display = 'none';
            modalCtx = { dayIndex: null, eventIndex: null };
        }

        modalOverlay.addEventListener('click', (e) => {
            if (e.target === modalOverlay) closeEventModal();
        });
        modalOverlay.querySelector('#closeModalBtn').addEventListener('click', closeEventModal);
        modalOverlay.querySelector('#deleteEventBtn').addEventListener('click', async () => {
            if (modalCtx.dayIndex === null || modalCtx.eventIndex === null) return;
            // Use existing deleteEvent helper
            const prevSelectedDay = selectedDay;
            selectedDay = modalCtx.dayIndex;
            await deleteEvent(modalCtx.eventIndex);
            selectedDay = prevSelectedDay;
            closeEventModal();
        });
    </script>
</body>
</html>
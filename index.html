<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Weekly Calendar & Events</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            height: 100vh;
            margin: 0;
            padding: 0;
            overflow: hidden;
        }

        .container {
            width: 100vw;
            height: calc(100vh - 112px);
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            display: flex;
            padding: 20px;
            gap: 20px;
        }

        /* Generic card */
        .card {
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            background: rgba(255, 255, 255, 0.95);
            box-shadow: 0 8px 16px rgba(0,0,0,0.06);
        }

        /* Top navigation bar */
        .top-nav {
            width: 100vw;
            height: 112px;
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.3);
            display: flex;
            flex-direction: column;
            justify-content: center;
            padding: 0 12px;
            gap: 6px;
        }

        .header-row {
            width: 100%;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .header-left,
        .header-right {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .app-logo {
            height: 72px;
            border-radius: 6px;
        }

        .greeting {
            font-size: 18px;
            font-weight: 600;
            color: #333;
        }

        .burger {
            width: 36px;
            height: 36px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            border: 1px solid rgba(102, 126, 234, 0.35);
            background: linear-gradient(135deg, rgba(255,255,255,0.9), rgba(255,255,255,0.7));
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .burger:hover { background: rgba(102, 126, 234, 0.12); }

        .burger .bar {
            width: 18px;
            height: 2px;
            background: #333;
            position: relative;
        }

        .burger .bar::before,
        .burger .bar::after {
            content: '';
            position: absolute;
            left: 0;
            width: 18px;
            height: 2px;
            background: #333;
        }

        .burger .bar::before { top: -6px; }
        .burger .bar::after { top: 6px; }

        .nav-item {
            appearance: none;
            border: 1px solid rgba(102, 126, 234, 0.35);
            background: linear-gradient(135deg, rgba(255,255,255,0.9), rgba(255,255,255,0.7));
            color: #333;
            padding: 8px 14px;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s ease;
        }

        .nav-item:hover {
            background: rgba(102, 126, 234, 0.12);
        }

        .nav-item.active {
            color: white;
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.9), rgba(118, 75, 162, 0.9));
            border-color: rgba(102, 126, 234, 0.8);
            text-shadow: 0 1px 2px rgba(0,0,0,0.25);
        }

        /* Views */
        .view { display: none; }
        .view.active { display: block; }

        .calendar-section {
            flex: 2;
            padding: 20px;
            background: rgba(255, 255, 255, 0.95);
            display: flex;
            flex-direction: column;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            box-shadow: 0 8px 16px rgba(0,0,0,0.06);
            position: relative;
        }

        .notes-section {
            flex: 1;
            padding: 0 0;
            display: flex;
            flex-direction: column;
        }

        .calendar-actions {
            position: absolute;
            top: 16px;
            right: 16px;
            display: flex;
            gap: 8px;
        }

        .events-card {
            padding: 20px;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            background: rgba(255, 255, 255, 0.95);
            box-shadow: 0 8px 16px rgba(0,0,0,0.06);
            display: flex;
            flex-direction: column;
            height: 100%;
        }

        .calendar-header {
            display: flex;
            justify-content: center;
            align-items: center;
            margin-bottom: 20px;
            flex-shrink: 0;
        }

        .week-year {
            font-size: 24px;
            font-weight: 600;
            color: #333;
        }

        .card-title {
            font-size: 24px;
            font-weight: 600;
            color: #333;
        }

        .week-grid {
            display: grid;
            grid-template-columns: 80px repeat(5, 1fr);
            gap: 1px;
            background: #e5e7eb;
            border: 1px solid #e5e7eb;
            flex: 1;
            overflow-y: auto;
            min-height: 0;
        }

        .week-grid .header {
            font-weight: 600;
            background: rgba(255, 255, 255, 0.9);
            color: #333;
            text-align: center;
            padding: 10px 0;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .time-cell {
            background: rgba(255, 255, 255, 0.8);
            color: #666;
            font-size: 11px;
            padding: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            height: 40px;
        }

        .slot-cell {
            background: rgba(255, 255, 255, 0.8);
            height: 40px;
            position: relative;
            cursor: pointer;
            transition: background 0.2s ease;
            border-bottom: 1px solid rgba(0, 0, 0, 0.05);
        }

        .slot-cell:hover {
            background: rgba(102, 126, 234, 0.15);
        }

        .slot-cell.today {
            background: rgba(118, 75, 162, 0.12);
        }

        .event-chip {
            position: absolute;
            left: 2px;
            right: 2px;
            top: 2px;
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.8), rgba(118, 75, 162, 0.8));
            border: 1px solid rgba(102, 126, 234, 0.6);
            border-radius: 6px;
            padding: 4px 6px;
            font-size: 11px;
            color: white;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s ease;
            font-weight: 500;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
            z-index: 5;
        }

        .event-chip:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }

        .notes-header {
            font-size: 20px;
            font-weight: 600;
            color: #333;
            margin-bottom: 20px;
            flex-shrink: 0;
        }

        .selected-date {
            color: #667eea;
            font-weight: 600;
            margin-bottom: 10px;
            flex-shrink: 0;
        }

        .events-list {
            flex: 1;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            padding: 15px;
            background: rgba(255, 255, 255, 0.8);
            overflow-y: auto;
            min-height: 0;
        }

        .event-item {
            background: rgba(102, 126, 234, 0.1);
            border: 1px solid rgba(102, 126, 234, 0.3);
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .event-item:hover {
            background: rgba(102, 126, 234, 0.2);
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        .event-item.selected {
            background: rgba(102, 126, 234, 0.25);
            border-color: rgba(102, 126, 234, 0.5);
            transform: translateY(-1px);
        }

        .event-time {
            font-size: 12px;
            color: #666;
            margin-bottom: 5px;
        }

        .event-title {
            font-weight: 600;
            color: #333;
            font-size: 16px;
        }

        .event-description {
            font-size: 14px;
            color: #666;
            margin-top: 5px;
        }

        .no-events {
            text-align: center;
            color: #999;
            font-style: italic;
            margin-top: 50px;
        }

        .delete-button {
            background: #ff4757;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            margin-top: 8px;
            transition: background 0.2s ease;
        }

        .delete-button:hover {
            background: #ff3742;
        }

        @media (max-width: 768px) {
            .container {
                flex-direction: column;
            }
            
            .calendar-section {
                border-bottom: 1px solid rgba(255, 255, 255, 0.2);
                flex: 1.5;
            }
            
            .notes-section {
                flex: 1;
            }
            
            .week-grid {
                grid-template-columns: 60px repeat(5, 1fr);
            }
        }

        /* Chat styles */
        .notes-wrapper {
            width: 100%;
            height: calc(100vh - 112px);
            display: flex;
            justify-content: center;
            align-items: flex-start;
            padding: 20px;
        }

        .notes-card {
            width: min(900px, 95vw);
            height: calc(100% - 40px);
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            padding: 16px;
            background: rgba(255,255,255,0.9);
            display: flex;
            flex-direction: column;
        }

        .notes-title {
            font-size: 24px;
            font-weight: 600;
            color: #333;
            text-align: left;
            margin-bottom: 12px;
        }

        .notes-list {
            flex: 1;
            overflow-y: auto;
            border: 1px solid #e5e7eb;
            border-radius: 10px;
            background: rgba(255,255,255,0.8);
            padding: 8px;
            min-height: 0;
        }

        .note-item {
            display: flex;
            align-items: center;
            gap: 8px;
            background: rgba(102, 126, 234, 0.08);
            border: 1px solid rgba(102, 126, 234, 0.25);
            border-radius: 8px;
            padding: 10px 12px;
            margin-bottom: 8px;
            transition: background 0.2s ease, box-shadow 0.2s ease;
        }

        .note-item:hover {
            background: rgba(102, 126, 234, 0.14);
            box-shadow: 0 2px 6px rgba(0,0,0,0.08);
        }

        .note-text {
            flex: 1;
            outline: none;
            border: none;
            background: transparent;
            font-size: 15px;
            color: #333;
            white-space: pre-wrap;
        }

        .note-text[contenteditable="true"]:empty:before {
            content: attr(data-placeholder);
            color: #aaa;
        }

        .note-delete {
            background: #ff4757;
            color: white;
            border: none;
            padding: 6px 10px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
        }

        .note-delete:hover {
            background: #ff3742;
        }

        /* Notes specific styles */
        .notes-composer {
            display: flex;
            gap: 8px;
            align-items: flex-end;
            margin-top: 12px;
            padding: 8px;
            border: 1px solid #e5e7eb;
            border-radius: 12px;
            background: rgba(255,255,255,0.9);
        }

        .note-input {
            flex: 1;
            border: none;
            outline: none;
            background: transparent;
            font-size: 14px;
            color: #333;
            padding: 8px;
            resize: vertical;
            min-height: 60px;
            font-family: inherit;
        }

        .note-input::placeholder {
            color: #aaa;
        }

        .add-note-button {
            width: 40px;
            height: 40px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            border-radius: 10px;
            border: 1px solid rgba(102, 126, 234, 0.35);
            background: linear-gradient(135deg, rgba(255,255,255,0.9), rgba(255,255,255,0.7));
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .add-note-button:hover {
            background: rgba(102, 126, 234, 0.12);
        }

        .note-edit {
            background: #667eea;
            color: white;
            border: none;
            padding: 6px 10px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            margin-left: 4px;
        }

        .note-edit:hover {
            background: #5a6fd8;
        }
        
        /* Chat specific components */
        .chat-card {
            padding: 20px;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            background: rgba(255, 255, 255, 0.95);
            box-shadow: 0 8px 16px rgba(0,0,0,0.06);
            display: flex;
            flex-direction: column;
            height: 100%;
        }

        .chat-header {
            font-size: 24px;
            font-weight: 600;
            color: #333;
            margin-bottom: 12px;
            flex-shrink: 0;
            text-align: center;
        }

        .chat-messages {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 10px;
            overflow-y: auto;
            padding: 10px;
            border: 1px solid #e5e7eb;
            border-radius: 10px;
            background: rgba(255,255,255,0.8);
            min-height: 0;
        }

        .chat-row {
            display: flex;
            gap: 8px;
            align-items: flex-end;
        }

        .chat-row.user { justify-content: flex-end; }
        .chat-row.assistant { justify-content: flex-start; }

        .chat-bubble {
            max-width: 80%;
            padding: 10px 12px;
            border-radius: 14px;
            font-size: 14px;
            line-height: 1.35;
            color: #222;
            background: rgba(102, 126, 234, 0.12);
            border: 1px solid rgba(102, 126, 234, 0.3);
        }
        .chat-row.user .chat-bubble {
            background: linear-gradient(135deg, rgba(102,126,234,0.9), rgba(118,75,162,0.9));
            color: #fff;
            border: 1px solid rgba(102,126,234,0.8);
        }

        .chat-composer {
            display: flex;
            gap: 8px;
            align-items: center;
            margin-top: 12px;
            padding: 8px;
            border: 1px solid #e5e7eb;
            border-radius: 12px;
            background: rgba(255,255,255,0.9);
        }

        .chat-input {
            flex: 1;
            border: none;
            outline: none;
            background: transparent;
            font-size: 14px;
            color: #333;
            padding: 8px;
        }

        .send-button {
            width: 40px;
            height: 40px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            border-radius: 10px;
            border: 1px solid rgba(102, 126, 234, 0.35);
            background: linear-gradient(135deg, rgba(255,255,255,0.9), rgba(255,255,255,0.7));
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .send-button:hover {
            background: rgba(102, 126, 234, 0.12);
        }

        .icon { width: 18px; height: 18px; color: #333; }
        /* Modal for calendar event details */
        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.35);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .modal {
            width: min(440px, 92vw);
            background: #fff;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            box-shadow: 0 12px 28px rgba(0,0,0,0.2);
            padding: 16px;
        }

        .modal-title {
            font-size: 18px;
            font-weight: 700;
            color: #333;
            margin-bottom: 6px;
        }

        .modal-subtitle {
            font-size: 13px;
            color: #666;
            margin-bottom: 10px;
        }

        .modal-description {
            font-size: 14px;
            color: #444;
            white-space: pre-wrap;
        }

        .modal-actions {
            margin-top: 14px;
            display: flex;
            justify-content: flex-end;
            gap: 8px;
        }

        .btn-secondary {
            appearance: none;
            border: 1px solid #e0e0e0;
            background: #f8f9fb;
            color: #333;
            padding: 8px 12px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
        }
    </style>
</head>
<body>
    <div class="top-nav">
        <div class="header-row">
            <div class="header-left">
                <img src="logo.png" alt="Logo" class="app-logo" />
            </div>
            <div class="header-right">
                <button class="nav-item" data-view="profile">Profile</button>
                <button class="burger" aria-label="Menu" title="Menu">
                    <span class="bar"></span>
                </button>
            </div>
        </div>
        <div class="header-row">
            <div class="header-left">
                <div class="greeting">Hello John</div>
            </div>
            <div class="header-right">
                <button class="nav-item active" data-view="calendar">Wochenplan</button>
                <button class="nav-item" data-view="notes">Maßnahmen</button>
                
            </div>
        </div>
    </div>

    <div id="view-calendar" class="view active">
        <div class="container">
            <div class="calendar-section">
                <div class="calendar-actions">
                    <button id="calendarExportBtn" class="nav-item" title="Export">Exportieren</button>
                </div>
                <div class="calendar-header">
                    <div class="week-year" id="weekYear"></div>
                </div>
                <div class="week-grid" id="weekGrid"></div>
            </div>
            
            <div class="notes-section">
                <div class="chat-card">
                    <div class="chat-header">KI Chat</div>
                    <div class="chat-messages" id="chatMessages"></div>
                    <div class="chat-composer">
                        <input id="chatInput" class="chat-input" placeholder="Type a message..." />
                        <button id="chatSend" class="send-button" title="Send" aria-label="Send">
                            <svg id="micIcon" class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M12 1a3 3 0 0 0-3 3v7a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"/>
                                <path d="M19 10v2a7 7 0 0 1-14 0v-2"/>
                                <line x1="12" y1="19" x2="12" y2="23"/>
                                <line x1="8" y1="23" x2="16" y2="23"/>
                            </svg>
                            <svg id="sendIcon" class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="display:none;">
                                <line x1="22" y1="2" x2="11" y2="13"/>
                                <polygon points="22 2 15 22 11 13 2 9 22 2"/>
                            </svg>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="view-notes" class="view">
        <div class="notes-wrapper">
            <div class="notes-card">
                <div class="notes-title">Maßnahmen</div>
                <div class="notes-list" id="notesList"></div>
                <div class="notes-composer">
                    <textarea id="noteInput" class="note-input" placeholder="Add a new note..." rows="3"></textarea>
                    <button id="addNoteBtn" class="add-note-button" title="Add Note" aria-label="Add Note">
                        <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <line x1="12" y1="5" x2="12" y2="19"/>
                            <line x1="5" y1="12" x2="19" y2="12"/>
                        </svg>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div id="view-export" class="view">
        <div class="container" style="justify-content:center; align-items:center;">
            <div style="border: 2px solid #e0e0e0; border-radius: 12px; padding: 24px; background: rgba(255,255,255,0.85);">
                <div style="font-size: 22px; font-weight: 700; color: #333; text-align:center;">Exportieren</div>
                <div style="margin-top: 8px; color:#666; text-align:center;">This section is coming soon.</div>
            </div>
        </div>
    </div>

    <div id="view-profile" class="view">
        <div class="container" style="justify-content:center; align-items:center;">
            <div style="border: 2px solid #e0e0e0; border-radius: 12px; padding: 24px; background: rgba(255,255,255,0.85);">
                <div style="font-size: 22px; font-weight: 700; color: #333; text-align:center;">Profile</div>
                <div style="margin-top: 8px; color:#666; text-align:center;">This section is coming soon.</div>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = 'http://127.0.0.1:8000';
        let selectedDay = null;
        let selectedEventIndex = null;
        let events = {};

        const dayNames = ["Montag", "Dienstag", "Mittwoch", "Donnerstag", "Freitag"];


        function formatDayKey(dayIndex) {
            return dayNames[dayIndex];
        }

        function formatDisplayDay(dayIndex) {
            return dayNames[dayIndex];
        }

        function getWeekDays() {
            return dayNames.map((day, index) => ({ name: day, index }));
        }

        function renderCalendar() {
            const weekYear = document.getElementById('weekYear');
            const weekGrid = document.getElementById('weekGrid');

            const weekDays = getWeekDays();

            weekYear.textContent = 'Dein Team Wochenplan';
            weekGrid.innerHTML = '';

            // Top-left empty header
            const emptyHeader = document.createElement('div');
            emptyHeader.className = 'header';
            emptyHeader.textContent = '';
            weekGrid.appendChild(emptyHeader);

            // Day headers Monday..Sunday
            weekDays.forEach((day) => {
                const header = document.createElement('div');
                header.className = 'header';
                header.textContent = day.name;
                weekGrid.appendChild(header);
            });

            // Create time slots from 06:00 to 20:00
            const startHour = 6;
            const endHour = 20;
            
            for (let hour = startHour; hour <= endHour; hour++) {
                // Time column
                const timeCell = document.createElement('div');
                timeCell.className = 'time-cell';
                const label24 = `${String(hour).padStart(2, '0')}:00`;
                timeCell.textContent = label24;
                weekGrid.appendChild(timeCell);

                // 7 day columns for this hour
                weekDays.forEach((day) => {
                    const slot = document.createElement('div');
                    slot.className = 'slot-cell';
                    slot.dataset.day = day.index;
                    slot.dataset.hour = String(hour);

                    // Check if this is the start of an event
                    const dayKey = formatDayKey(day.index);
                    const dayEvents = events[dayKey] || [];
                    const eventAtThisHour = dayEvents.find(ev => Number(ev.hour) === hour);
                    
                    if (eventAtThisHour) {
                        const chip = document.createElement('div');
                        chip.className = 'event-chip';
                        chip.textContent = eventAtThisHour.title || 'Event';
                        chip.title = eventAtThisHour.description ? 
                            `${eventAtThisHour.title} — ${eventAtThisHour.description} (${eventAtThisHour.duration || 1}h)` : 
                            `${eventAtThisHour.title} (${eventAtThisHour.duration || 1}h)`;
                        
                        // Style based on duration - span multiple cells
                        const duration = eventAtThisHour.duration || 1;
                        chip.style.height = `${(duration * 40) - 2}px`;
                        
                        // Click event to select this event in notes section
                        chip.addEventListener('click', (e) => {
                            e.stopPropagation();
                            selectEvent(day.index, dayEvents.indexOf(eventAtThisHour));
                        });
                        
                        slot.appendChild(chip);
                    }

                    // Empty slot click to add new event
                    if (!eventAtThisHour) {
                        slot.addEventListener('click', () => onSlotClick(day.index, hour));
                    }
                    
                    weekGrid.appendChild(slot);
                });
            }
        }

        function selectDay(dayIndex) {
            selectedDay = dayIndex;
            selectedEventIndex = null;
            const selectedDateElement = document.getElementById('selectedDate');
            const eventsList = document.getElementById('eventsList');
            // Gracefully handle when the side panel is not present
            if (!selectedDateElement || !eventsList) {
                return;
            }
            
            selectedDateElement.textContent = formatDisplayDay(dayIndex);
            
            // Load events for selected day
            const dayKey = formatDayKey(dayIndex);
            const dayEvents = events[dayKey] || [];
            
            eventsList.innerHTML = '';
            
            if (dayEvents.length === 0) {
                const noEvents = document.createElement('div');
                noEvents.className = 'no-events';
                noEvents.textContent = 'No events for this day. Click a time slot to add an event.';
                eventsList.appendChild(noEvents);
            } else {
                const withIndex = dayEvents.map((ev, originalIndex) => ({ ev, originalIndex }));
                withIndex.sort((a, b) => Number(a.ev.hour) - Number(b.ev.hour));
                withIndex.forEach(({ ev: event, originalIndex }, index) => {
                    const eventElement = document.createElement('div');
                    eventElement.className = 'event-item';
                    if (selectedEventIndex === index) {
                        eventElement.classList.add('selected');
                    }
                    
                    const hour = Number(event.hour);
                    const duration = event.duration || 1;
                    const ampm = `${String(hour).padStart(2, '0')}:00`;
                    const endHour = hour + duration;
                    const endAmpm = `${String(endHour).padStart(2, '0')}:00`;
                    
                    eventElement.innerHTML = `
                        <div class="event-time">${ampm} - ${endAmpm} (${duration}h)</div>
                        <div class="event-title">${event.title}</div>
                        ${event.description ? `<div class="event-description">${event.description}</div>` : ''}
                    `;
                    
                    eventElement.addEventListener('click', () => {
                        selectedEventIndex = index;
                        selectDay(selectedDay); // Refresh to show selection
                    });
                    
                    eventsList.appendChild(eventElement);
                });
            }
        }

        function selectEvent(dayIndex, eventIndex) {
            selectedDay = dayIndex;
            selectedEventIndex = eventIndex;
            openEventModal(dayIndex, eventIndex);
        }

        async function deleteEvent(eventIndex) {
            if (!confirm('Delete this event?')) return;
            const dayKey = formatDayKey(selectedDay);
            try {
                const res = await fetch(`${API_BASE}/events?day=${encodeURIComponent(dayKey)}&index=${encodeURIComponent(eventIndex)}`, {
                    method: 'DELETE',
                    headers: { 'Content-Type': 'application/json' },
                });
                if (!res.ok) {
                    const err = await res.json().catch(() => ({}));
                    alert(err.detail || 'Failed to delete event');
                    return;
                }
                const data = await res.json();
                events = data.events || {};
                selectedEventIndex = null;
                // Always re-render the calendar grid
                renderCalendar();
                // Update the optional side panel if it exists
                try {
                    selectDay(selectedDay);
                } catch (_) {
                    // Ignore UI panel update errors
                }
            } catch (e) {
                alert('Could not reach backend. Is it running on 127.0.0.1:8000?');
            }
        }

        async function onSlotClick(dayIndex, hour) {
            selectedDay = dayIndex;
            const title = prompt('Event title:');
            if (!title) return;
            const description = prompt('Description (optional):');
            const durationInput = prompt('Duration in hours (default: 1):');
            const duration = durationInput ? parseInt(durationInput) || 1 : 1;

            // Validate that the event fits within the 6am-8pm range
            const startHour = 6;
            const endHour = 20;
            if (hour < startHour || hour + duration > endHour + 1) {
                alert(`Event must be within ${startHour} to ${endHour} range.`);
                return;
            }

            // Check for overlapping events
            const key = formatDayKey(dayIndex);
            const dayEvents = events[key] || [];
            const hasOverlap = dayEvents.some(existingEvent => {
                const existingStart = Number(existingEvent.hour);
                const existingEnd = existingStart + (existingEvent.duration || 1);
                const newStart = hour;
                const newEnd = hour + duration;
                
                return (newStart < existingEnd && newEnd > existingStart);
            });

            if (hasOverlap) {
                alert('This time slot overlaps with an existing event. Please choose a different time.');
                return;
            }

            try {
                const res = await fetch(`${API_BASE}/events`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        day: key,
                        event: { title, description: description || '', hour: Number(hour), duration }
                    })
                });
                if (!res.ok) {
                    const err = await res.json().catch(() => ({}));
                    alert(err.detail || 'Failed to add event');
                    return;
                }
                const data = await res.json();
                events = data.events || {};
                renderCalendar();
                selectDay(selectedDay);
            } catch (e) {
                alert('Could not reach backend. Is it running on 127.0.0.1:8000?');
            }
        }

        async function loadEvents() {
            try {
                const res = await fetch(`${API_BASE}/events`);
                if (!res.ok) {
                    throw new Error('Failed to load events');
                }
                const data = await res.json();
                events = data.events || {};
            } catch (e) {
                // Keep empty events but notify user once
                console.warn('Could not load events from backend:', e);
            }
        }

        // Simple view switching
        function switchView(viewName) {
            const views = document.querySelectorAll('.view');
            views.forEach(v => v.classList.remove('active'));
            const target = document.getElementById(`view-${viewName}`);
            if (target) target.classList.add('active');

            const tabs = document.querySelectorAll('.nav-item');
            tabs.forEach(t => t.classList.remove('active'));
            const activeTab = document.querySelector(`.nav-item[data-view="${viewName}"]`);
            if (activeTab) activeTab.classList.add('active');

            if (viewName === 'calendar') {
                renderCalendar();
                if (selectedDay !== null) selectDay(selectedDay);
            } else if (viewName === 'notes') {
                initNotesView();
            }
        }

        document.querySelectorAll('.nav-item').forEach(btn => {
            btn.addEventListener('click', () => switchView(btn.dataset.view));
        });

        // Initialize calendar with backend data
        (async () => {
            await loadEvents();
            renderCalendar();
        })();

        // Make calendar responsive to window resize
        window.addEventListener('resize', () => {
            renderCalendar();
            if (selectedDay !== null) selectDay(selectedDay);
        });

        // Notes logic
        let notes = [];
        let editingNoteId = null;

        async function loadNotes() {
            try {
                const res = await fetch(`${API_BASE}/notes`);
                if (!res.ok) throw new Error('Failed to load notes');
                const data = await res.json();
                notes = data.notes || [];
                renderNotes();
            } catch (e) {
                console.warn('Could not load notes from backend:', e);
                notes = [];
                renderNotes();
            }
        }

        async function addNote(text) {
            if (!text.trim()) return;
            try {
                const res = await fetch(`${API_BASE}/notes`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ text: text.trim() })
                });
                if (!res.ok) throw new Error('Failed to add note');
                const data = await res.json();
                notes = data.notes || [];
                renderNotes();
            } catch (e) {
                console.error('Could not add note:', e);
                alert('Could not add note. Is the backend running?');
            }
        }

        async function updateNote(noteId, text) {
            try {
                const res = await fetch(`${API_BASE}/notes/${noteId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ text: text.trim() })
                });
                if (!res.ok) throw new Error('Failed to update note');
                const data = await res.json();
                notes = data.notes || [];
                renderNotes();
            } catch (e) {
                console.error('Could not update note:', e);
                alert('Could not update note. Is the backend running?');
            }
        }

        async function deleteNote(noteId) {
            if (!confirm('Delete this note?')) return;
            try {
                const res = await fetch(`${API_BASE}/notes/${noteId}`, {
                    method: 'DELETE'
                });
                if (!res.ok) throw new Error('Failed to delete note');
                const data = await res.json();
                notes = data.notes || [];
                renderNotes();
            } catch (e) {
                console.error('Could not delete note:', e);
                alert('Could not delete note. Is the backend running?');
            }
        }

        function renderNotes() {
            const container = document.getElementById('notesList');
            if (!container) return;
            
            container.innerHTML = '';
            
            if (notes.length === 0) {
                const emptyMsg = document.createElement('div');
                emptyMsg.className = 'no-events';
                emptyMsg.textContent = 'No notes yet. Add your first note below.';
                container.appendChild(emptyMsg);
                return;
            }

            notes.forEach(note => {
                const noteElement = document.createElement('div');
                noteElement.className = 'note-item';
                
                if (editingNoteId === note.id) {
                    // Edit mode
                    const textarea = document.createElement('textarea');
                    textarea.className = 'note-text';
                    textarea.value = note.text;
                    textarea.rows = 3;
                    
                    const saveBtn = document.createElement('button');
                    saveBtn.className = 'note-edit';
                    saveBtn.textContent = 'Save';
                    saveBtn.onclick = () => {
                        updateNote(note.id, textarea.value);
                        editingNoteId = null;
                    };
                    
                    const cancelBtn = document.createElement('button');
                    cancelBtn.className = 'note-delete';
                    cancelBtn.textContent = 'Cancel';
                    cancelBtn.onclick = () => {
                        editingNoteId = null;
                        renderNotes();
                    };
                    
                    noteElement.appendChild(textarea);
                    noteElement.appendChild(saveBtn);
                    noteElement.appendChild(cancelBtn);
                } else {
                    // View mode
                    const textSpan = document.createElement('span');
                    textSpan.className = 'note-text';
                    textSpan.textContent = note.text;
                    
                    const editBtn = document.createElement('button');
                    editBtn.className = 'note-edit';
                    editBtn.textContent = 'Edit';
                    editBtn.onclick = () => {
                        editingNoteId = note.id;
                        renderNotes();
                    };
                    
                    const deleteBtn = document.createElement('button');
                    deleteBtn.className = 'note-delete';
                    deleteBtn.textContent = 'Delete';
                    deleteBtn.onclick = () => deleteNote(note.id);
                    
                    noteElement.appendChild(textSpan);
                    noteElement.appendChild(editBtn);
                    noteElement.appendChild(deleteBtn);
                }
                
                container.appendChild(noteElement);
            });
        }

        function initNotesView() {
            loadNotes();
            
            const noteInput = document.getElementById('noteInput');
            const addBtn = document.getElementById('addNoteBtn');
            
            if (noteInput && addBtn) {
                addBtn.onclick = () => {
                    const text = noteInput.value.trim();
                    if (text) {
                        addNote(text);
                        noteInput.value = '';
                    }
                };
                
                noteInput.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter' && e.ctrlKey) {
                        e.preventDefault();
                        const text = noteInput.value.trim();
                        if (text) {
                            addNote(text);
                            noteInput.value = '';
                        }
                    }
                });
            }
        }

        // Initialize notes when page loads
        (async () => {
            await loadNotes();
        })();

        // Chat logic for calendar sidebar (frontend-only placeholder storage)
        const CHAT_STORAGE_KEY = 'chat_messages_v1';
        function loadChatMessages() {
            try {
                const raw = localStorage.getItem(CHAT_STORAGE_KEY) || '[]';
                const parsed = JSON.parse(raw);
                const messages = Array.isArray(parsed) ? parsed : [];
                
                // Ensure there's always a welcome message from AI as the first entry
                if (messages.length === 0 || messages[0].role !== 'assistant') {
                    const welcomeMessage = { role: 'assistant', text: 'Hello and welcome, how can I help you?' };
                    messages.unshift(welcomeMessage);
                    saveChatMessages(messages);
                }
                
                return messages;
            } catch { 
                // If there's an error, return just the welcome message
                const welcomeMessage = [{ role: 'assistant', text: 'Hello and welcome, how can I help you?' }];
                saveChatMessages(welcomeMessage);
                return welcomeMessage;
            }
        }
        function saveChatMessages(msgs) {
            localStorage.setItem(CHAT_STORAGE_KEY, JSON.stringify(msgs));
        }
        async function fetchChatFromBackend() {
            try {
                const res = await fetch(`${API_BASE}/chat`);
                if (!res.ok) return null;
                const data = await res.json();
                if (!data || !Array.isArray(data.messages)) return null;
                
                // Ensure there's always a welcome message from AI as the first entry
                const messages = data.messages;
                if (messages.length === 0 || messages[0].role !== 'assistant') {
                    const welcomeMessage = { role: 'assistant', text: 'Hello and welcome, how can I help you?' };
                    messages.unshift(welcomeMessage);
                }
                
                return messages;
            } catch { return null; }
        }
        async function postChatToBackend(message) {
            try {
                await fetch(`${API_BASE}/chat`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ role: 'user', text: message })
                });
            } catch { /* ignore network errors, localStorage is primary */ }
        }
        function renderChatMessages(containerId, messages) {
            const container = document.getElementById(containerId);
            if (!container) return;
            container.innerHTML = '';
            messages.forEach(m => {
                const row = document.createElement('div');
                row.className = `chat-row ${m.role}`;
                const bubble = document.createElement('div');
                bubble.className = 'chat-bubble';
                bubble.textContent = m.text;
                row.appendChild(bubble);
                container.appendChild(row);
            });
            container.scrollTop = container.scrollHeight;
        }
        function hookupComposer(inputId, sendBtnId, micIconId, sendIconId, renderTargetId) {
            const input = document.getElementById(inputId);
            const btn = document.getElementById(sendBtnId);
            const mic = document.getElementById(micIconId);
            const send = document.getElementById(sendIconId);
            if (!input || !btn || !mic || !send) return;
            function updateIcons() {
                const hasText = input.value.trim().length > 0;
                mic.style.display = hasText ? 'none' : 'block';
                send.style.display = hasText ? 'block' : 'none';
            }
            input.addEventListener('input', updateIcons);
            async function submit() {
                const text = input.value.trim();
                if (!text) return;
                const messages = loadChatMessages();
                messages.push({ role: 'user', text });
                
                // Add mock AI reply that echoes the user input
                messages.push({ role: 'assistant', text: `You said: "${text}"` });
                
                saveChatMessages(messages);
                renderChatMessages(renderTargetId, messages);
                // Try to persist to backend for consistency (best-effort)
                postChatToBackend(text);
                input.value = '';
                updateIcons();
            }
            btn.addEventListener('click', submit);
            input.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    submit();
                }
            });
            updateIcons();
        }

        // Initialize chat in the calendar sidebar
        hookupComposer('chatInput','chatSend','micIcon','sendIcon','chatMessages');
        (async () => {
            const localMsgs = loadChatMessages();
            renderChatMessages('chatMessages', localMsgs);
            const backendMsgs = await fetchChatFromBackend();
            if (backendMsgs) {
                saveChatMessages(backendMsgs);
                renderChatMessages('chatMessages', backendMsgs);
            }
        })();

        // Export button inside calendar
        const calendarExportBtn = document.getElementById('calendarExportBtn');
        if (calendarExportBtn) {
            calendarExportBtn.addEventListener('click', () => switchView('export'));
        }

        // Modal structure
        const modalOverlay = document.createElement('div');
        modalOverlay.className = 'modal-overlay';
        modalOverlay.innerHTML = `
            <div class="modal" role="dialog" aria-modal="true">
                <div class="modal-title" id="modalTitle"></div>
                <div class="modal-subtitle" id="modalTime"></div>
                <div class="modal-description" id="modalDescription"></div>
                <div class="modal-actions">
                    <button class="btn-secondary" id="closeModalBtn">Close</button>
                    <button class="delete-button" id="deleteEventBtn">Delete</button>
                </div>
            </div>`;
        document.body.appendChild(modalOverlay);

        let modalCtx = { dayIndex: null, eventIndex: null };

        function openEventModal(dayIndex, eventIndex) {
            const dayKey = formatDayKey(dayIndex);
            const dayEvents = events[dayKey] || [];
            const ev = dayEvents[eventIndex];
            if (!ev) return;

            const hour = Number(ev.hour);
            const duration = ev.duration || 1;
            const start = `${String(hour).padStart(2,'0')}:00`;
            const end = `${String(hour + duration).padStart(2,'0')}:00`;

            document.getElementById('modalTitle').textContent = ev.title || 'Event';
            document.getElementById('modalTime').textContent = `${formatDisplayDay(dayIndex)} • ${start} - ${end} (${duration}h)`;
            document.getElementById('modalDescription').textContent = ev.description || '';

            modalCtx = { dayIndex, eventIndex };
            modalOverlay.style.display = 'flex';
        }

        function closeEventModal() {
            modalOverlay.style.display = 'none';
            modalCtx = { dayIndex: null, eventIndex: null };
        }

        modalOverlay.addEventListener('click', (e) => {
            if (e.target === modalOverlay) closeEventModal();
        });
        modalOverlay.querySelector('#closeModalBtn').addEventListener('click', closeEventModal);
        modalOverlay.querySelector('#deleteEventBtn').addEventListener('click', async () => {
            if (modalCtx.dayIndex === null || modalCtx.eventIndex === null) return;
            // Use existing deleteEvent helper
            const prevSelectedDay = selectedDay;
            selectedDay = modalCtx.dayIndex;
            await deleteEvent(modalCtx.eventIndex);
            selectedDay = prevSelectedDay;
            closeEventModal();
        });
    </script>
</body>
</html>
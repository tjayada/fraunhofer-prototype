<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Weekly Calendar & Events</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            height: 100vh;
            margin: 0;
            padding: 0;
            overflow: hidden;
        }

        .container {
            width: 100vw;
            height: calc(100vh - 112px);
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            display: flex;
            padding: 20px;
            gap: 20px;
        }

        /* Generic card */
        .card {
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            background: rgba(255, 255, 255, 0.95);
            box-shadow: 0 8px 16px rgba(0,0,0,0.06);
        }

        /* Top navigation bar */
        .top-nav {
            width: 100vw;
            height: 112px;
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.3);
            display: flex;
            flex-direction: column;
            justify-content: center;
            padding: 0 12px;
            gap: 6px;
        }

        .header-row {
            width: 100%;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .header-left,
        .header-right {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .app-logo {
            height: 36px;
            border-radius: 6px;
        }

        .greeting {
            font-size: 18px;
            font-weight: 600;
            color: #333;
        }

        .burger {
            width: 36px;
            height: 36px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            border: 1px solid rgba(102, 126, 234, 0.35);
            background: linear-gradient(135deg, rgba(255,255,255,0.9), rgba(255,255,255,0.7));
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .burger:hover { background: rgba(102, 126, 234, 0.12); }

        .burger .bar {
            width: 18px;
            height: 2px;
            background: #333;
            position: relative;
        }

        .burger .bar::before,
        .burger .bar::after {
            content: '';
            position: absolute;
            left: 0;
            width: 18px;
            height: 2px;
            background: #333;
        }

        .burger .bar::before { top: -6px; }
        .burger .bar::after { top: 6px; }

        .nav-item {
            appearance: none;
            border: 1px solid rgba(102, 126, 234, 0.35);
            background: linear-gradient(135deg, rgba(255,255,255,0.9), rgba(255,255,255,0.7));
            color: #333;
            padding: 8px 14px;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s ease;
        }

        .nav-item:hover {
            background: rgba(102, 126, 234, 0.12);
        }

        .nav-item.active {
            color: white;
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.9), rgba(118, 75, 162, 0.9));
            border-color: rgba(102, 126, 234, 0.8);
            text-shadow: 0 1px 2px rgba(0,0,0,0.25);
        }

        /* Views */
        .view { display: none; }
        .view.active { display: block; }

        .calendar-section {
            flex: 2;
            padding: 20px;
            background: rgba(255, 255, 255, 0.95);
            display: flex;
            flex-direction: column;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            box-shadow: 0 8px 16px rgba(0,0,0,0.06);
            position: relative;
        }

        .notes-section {
            flex: 1;
            padding: 0 0;
            display: flex;
            flex-direction: column;
        }

        .calendar-actions {
            position: absolute;
            top: 16px;
            right: 16px;
            display: flex;
            gap: 8px;
        }

        .events-card {
            padding: 20px;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            background: rgba(255, 255, 255, 0.95);
            box-shadow: 0 8px 16px rgba(0,0,0,0.06);
            display: flex;
            flex-direction: column;
            height: 100%;
        }

        .calendar-header {
            display: flex;
            justify-content: center;
            align-items: center;
            margin-bottom: 20px;
            flex-shrink: 0;
        }

        .week-year {
            font-size: 24px;
            font-weight: 600;
            color: #333;
        }

        .week-grid {
            display: grid;
            grid-template-columns: 80px repeat(5, 1fr);
            gap: 1px;
            background: #e5e7eb;
            border: 1px solid #e5e7eb;
            flex: 1;
            overflow-y: auto;
            min-height: 0;
        }

        .week-grid .header {
            font-weight: 600;
            background: rgba(255, 255, 255, 0.9);
            color: #333;
            text-align: center;
            padding: 10px 0;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .time-cell {
            background: rgba(255, 255, 255, 0.8);
            color: #666;
            font-size: 11px;
            padding: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            height: 40px;
        }

        .slot-cell {
            background: rgba(255, 255, 255, 0.8);
            height: 40px;
            position: relative;
            cursor: pointer;
            transition: background 0.2s ease;
            border-bottom: 1px solid rgba(0, 0, 0, 0.05);
        }

        .slot-cell:hover {
            background: rgba(102, 126, 234, 0.15);
        }

        .slot-cell.today {
            background: rgba(118, 75, 162, 0.12);
        }

        .event-chip {
            position: absolute;
            left: 2px;
            right: 2px;
            top: 2px;
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.8), rgba(118, 75, 162, 0.8));
            border: 1px solid rgba(102, 126, 234, 0.6);
            border-radius: 6px;
            padding: 4px 6px;
            font-size: 11px;
            color: white;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s ease;
            font-weight: 500;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
            z-index: 5;
        }

        .event-chip:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }

        .notes-header {
            font-size: 20px;
            font-weight: 600;
            color: #333;
            margin-bottom: 20px;
            flex-shrink: 0;
        }

        .selected-date {
            color: #667eea;
            font-weight: 600;
            margin-bottom: 10px;
            flex-shrink: 0;
        }

        .events-list {
            flex: 1;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            padding: 15px;
            background: rgba(255, 255, 255, 0.8);
            overflow-y: auto;
            min-height: 0;
        }

        .event-item {
            background: rgba(102, 126, 234, 0.1);
            border: 1px solid rgba(102, 126, 234, 0.3);
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .event-item:hover {
            background: rgba(102, 126, 234, 0.2);
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        .event-item.selected {
            background: rgba(102, 126, 234, 0.25);
            border-color: rgba(102, 126, 234, 0.5);
            transform: translateY(-1px);
        }

        .event-time {
            font-size: 12px;
            color: #666;
            margin-bottom: 5px;
        }

        .event-title {
            font-weight: 600;
            color: #333;
            font-size: 16px;
        }

        .event-description {
            font-size: 14px;
            color: #666;
            margin-top: 5px;
        }

        .no-events {
            text-align: center;
            color: #999;
            font-style: italic;
            margin-top: 50px;
        }

        .delete-button {
            background: #ff4757;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            margin-top: 8px;
            transition: background 0.2s ease;
        }

        .delete-button:hover {
            background: #ff3742;
        }

        @media (max-width: 768px) {
            .container {
                flex-direction: column;
            }
            
            .calendar-section {
                border-bottom: 1px solid rgba(255, 255, 255, 0.2);
                flex: 1.5;
            }
            
            .notes-section {
                flex: 1;
            }
            
            .week-grid {
                grid-template-columns: 60px repeat(5, 1fr);
            }
        }

        /* Notes view styles */
        .notes-wrapper {
            width: 100%;
            height: calc(100vh - 112px);
            display: flex;
            justify-content: center;
            align-items: flex-start;
            padding: 20px;
        }

        .notes-card {
            width: min(900px, 95vw);
            height: calc(100% - 40px);
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            padding: 16px;
            background: rgba(255,255,255,0.9);
            display: flex;
            flex-direction: column;
        }

        .notes-title {
            font-size: 22px;
            font-weight: 700;
            color: #333;
            text-align: left;
            margin-bottom: 12px;
        }

        .notes-list {
            flex: 1;
            overflow-y: auto;
            border: 1px solid #e5e7eb;
            border-radius: 10px;
            background: rgba(255,255,255,0.8);
            padding: 8px;
            min-height: 0;
        }

        .note-item {
            display: flex;
            align-items: center;
            gap: 8px;
            background: rgba(102, 126, 234, 0.08);
            border: 1px solid rgba(102, 126, 234, 0.25);
            border-radius: 8px;
            padding: 10px 12px;
            margin-bottom: 8px;
            transition: background 0.2s ease, box-shadow 0.2s ease;
        }

        .note-item:hover {
            background: rgba(102, 126, 234, 0.14);
            box-shadow: 0 2px 6px rgba(0,0,0,0.08);
        }

        .note-text {
            flex: 1;
            outline: none;
            border: none;
            background: transparent;
            font-size: 15px;
            color: #333;
            white-space: pre-wrap;
        }

        .note-text[contenteditable="true"]:empty:before {
            content: attr(data-placeholder);
            color: #aaa;
        }

        .note-delete {
            background: #ff4757;
            color: white;
            border: none;
            padding: 6px 10px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
        }

        .note-delete:hover {
            background: #ff3742;
        }
        /* Modal for calendar event details */
        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.35);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .modal {
            width: min(440px, 92vw);
            background: #fff;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            box-shadow: 0 12px 28px rgba(0,0,0,0.2);
            padding: 16px;
        }

        .modal-title {
            font-size: 18px;
            font-weight: 700;
            color: #333;
            margin-bottom: 6px;
        }

        .modal-subtitle {
            font-size: 13px;
            color: #666;
            margin-bottom: 10px;
        }

        .modal-description {
            font-size: 14px;
            color: #444;
            white-space: pre-wrap;
        }

        .modal-actions {
            margin-top: 14px;
            display: flex;
            justify-content: flex-end;
            gap: 8px;
        }

        .btn-secondary {
            appearance: none;
            border: 1px solid #e0e0e0;
            background: #f8f9fb;
            color: #333;
            padding: 8px 12px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
        }
    </style>
</head>
<body>
    <div class="top-nav">
        <div class="header-row">
            <div class="header-left">
                <img src="logo.JPG" alt="Logo" class="app-logo" />
            </div>
            <div class="header-right">
                <button class="nav-item" data-view="profile">Profile</button>
                <button class="burger" aria-label="Menu" title="Menu">
                    <span class="bar"></span>
                </button>
            </div>
        </div>
        <div class="header-row">
            <div class="header-left">
                <div class="greeting">Hello John</div>
            </div>
            <div class="header-right">
                <button class="nav-item active" data-view="calendar">Calendar</button>
                <button class="nav-item" data-view="notes">Notes</button>
                
            </div>
        </div>
    </div>

    <div id="view-calendar" class="view active">
        <div class="container">
            <div class="calendar-section">
                <div class="calendar-actions">
                    <button id="calendarExportBtn" class="nav-item" title="Export">Export</button>
                </div>
                <div class="calendar-header">
                    <div class="week-year" id="weekYear"></div>
                </div>
                <div class="week-grid" id="weekGrid"></div>
            </div>
            
            <div class="notes-section">
                <div class="events-card">
                    <div class="notes-header">Events</div>
                    <div class="selected-date" id="selectedDate">Select a day to view events</div>
                    <div class="events-list" id="eventsList">
                        <div class="no-events">Click on a day to add an event</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="view-notes" class="view">
        <div class="notes-wrapper">
            <div class="notes-card">
                <div class="notes-title">Notes</div>
                <div class="notes-list" id="notesList">
                    <!-- Notes render here. The last row is always an empty editable line -->
                </div>
            </div>
        </div>
    </div>

    <div id="view-export" class="view">
        <div class="container" style="justify-content:center; align-items:center;">
            <div style="border: 2px solid #e0e0e0; border-radius: 12px; padding: 24px; background: rgba(255,255,255,0.85);">
                <div style="font-size: 22px; font-weight: 700; color: #333; text-align:center;">Export</div>
                <div style="margin-top: 8px; color:#666; text-align:center;">This section is coming soon.</div>
            </div>
        </div>
    </div>

    <div id="view-profile" class="view">
        <div class="container" style="justify-content:center; align-items:center;">
            <div style="border: 2px solid #e0e0e0; border-radius: 12px; padding: 24px; background: rgba(255,255,255,0.85);">
                <div style="font-size: 22px; font-weight: 700; color: #333; text-align:center;">Profile</div>
                <div style="margin-top: 8px; color:#666; text-align:center;">This section is coming soon.</div>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = 'http://127.0.0.1:8000';
        let selectedDay = null;
        let selectedEventIndex = null;
        let events = {};

        const dayNames = ["Montag", "Dienstag", "Mittwoch", "Donnerstag", "Freitag"];


        function formatDayKey(dayIndex) {
            return dayNames[dayIndex];
        }

        function formatDisplayDay(dayIndex) {
            return dayNames[dayIndex];
        }

        function getWeekDays() {
            return dayNames.map((day, index) => ({ name: day, index }));
        }

        function renderCalendar() {
            const weekYear = document.getElementById('weekYear');
            const weekGrid = document.getElementById('weekGrid');

            const weekDays = getWeekDays();

            weekYear.textContent = 'Weekly Schedule';
            weekGrid.innerHTML = '';

            // Top-left empty header
            const emptyHeader = document.createElement('div');
            emptyHeader.className = 'header';
            emptyHeader.textContent = '';
            weekGrid.appendChild(emptyHeader);

            // Day headers Monday..Sunday
            weekDays.forEach((day) => {
                const header = document.createElement('div');
                header.className = 'header';
                header.textContent = day.name;
                weekGrid.appendChild(header);
            });

            // Create time slots from 06:00 to 20:00
            const startHour = 6;
            const endHour = 20;
            
            for (let hour = startHour; hour <= endHour; hour++) {
                // Time column
                const timeCell = document.createElement('div');
                timeCell.className = 'time-cell';
                const label24 = `${String(hour).padStart(2, '0')}:00`;
                timeCell.textContent = label24;
                weekGrid.appendChild(timeCell);

                // 7 day columns for this hour
                weekDays.forEach((day) => {
                    const slot = document.createElement('div');
                    slot.className = 'slot-cell';
                    slot.dataset.day = day.index;
                    slot.dataset.hour = String(hour);

                    // Check if this is the start of an event
                    const dayKey = formatDayKey(day.index);
                    const dayEvents = events[dayKey] || [];
                    const eventAtThisHour = dayEvents.find(ev => Number(ev.hour) === hour);
                    
                    if (eventAtThisHour) {
                        const chip = document.createElement('div');
                        chip.className = 'event-chip';
                        chip.textContent = eventAtThisHour.title || 'Event';
                        chip.title = eventAtThisHour.description ? 
                            `${eventAtThisHour.title} — ${eventAtThisHour.description} (${eventAtThisHour.duration || 1}h)` : 
                            `${eventAtThisHour.title} (${eventAtThisHour.duration || 1}h)`;
                        
                        // Style based on duration - span multiple cells
                        const duration = eventAtThisHour.duration || 1;
                        chip.style.height = `${(duration * 40) - 2}px`;
                        
                        // Click event to select this event in notes section
                        chip.addEventListener('click', (e) => {
                            e.stopPropagation();
                            selectEvent(day.index, dayEvents.indexOf(eventAtThisHour));
                        });
                        
                        slot.appendChild(chip);
                    }

                    // Empty slot click to add new event
                    if (!eventAtThisHour) {
                        slot.addEventListener('click', () => onSlotClick(day.index, hour));
                    }
                    
                    weekGrid.appendChild(slot);
                });
            }
        }

        function selectDay(dayIndex) {
            selectedDay = dayIndex;
            selectedEventIndex = null;
            const selectedDateElement = document.getElementById('selectedDate');
            const eventsList = document.getElementById('eventsList');
            
            selectedDateElement.textContent = formatDisplayDay(dayIndex);
            
            // Load events for selected day
            const dayKey = formatDayKey(dayIndex);
            const dayEvents = events[dayKey] || [];
            
            eventsList.innerHTML = '';
            
            if (dayEvents.length === 0) {
                const noEvents = document.createElement('div');
                noEvents.className = 'no-events';
                noEvents.textContent = 'No events for this day. Click a time slot to add an event.';
                eventsList.appendChild(noEvents);
            } else {
                const withIndex = dayEvents.map((ev, originalIndex) => ({ ev, originalIndex }));
                withIndex.sort((a, b) => Number(a.ev.hour) - Number(b.ev.hour));
                withIndex.forEach(({ ev: event, originalIndex }, index) => {
                    const eventElement = document.createElement('div');
                    eventElement.className = 'event-item';
                    if (selectedEventIndex === index) {
                        eventElement.classList.add('selected');
                    }
                    
                    const hour = Number(event.hour);
                    const duration = event.duration || 1;
                    const ampm = `${String(hour).padStart(2, '0')}:00`;
                    const endHour = hour + duration;
                    const endAmpm = `${String(endHour).padStart(2, '0')}:00`;
                    
                    eventElement.innerHTML = `
                        <div class="event-time">${ampm} - ${endAmpm} (${duration}h)</div>
                        <div class="event-title">${event.title}</div>
                        ${event.description ? `<div class="event-description">${event.description}</div>` : ''}
                    `;
                    
                    eventElement.addEventListener('click', () => {
                        selectedEventIndex = index;
                        selectDay(selectedDay); // Refresh to show selection
                    });
                    
                    eventsList.appendChild(eventElement);
                });
            }
        }

        function selectEvent(dayIndex, eventIndex) {
            selectedDay = dayIndex;
            selectedEventIndex = eventIndex;
            openEventModal(dayIndex, eventIndex);
        }

        async function deleteEvent(eventIndex) {
            if (!confirm('Delete this event?')) return;
            const dayKey = formatDayKey(selectedDay);
            try {
                const res = await fetch(`${API_BASE}/events?day=${encodeURIComponent(dayKey)}&index=${encodeURIComponent(eventIndex)}`, {
                    method: 'DELETE',
                    headers: { 'Content-Type': 'application/json' },
                });
                if (!res.ok) {
                    const err = await res.json().catch(() => ({}));
                    alert(err.detail || 'Failed to delete event');
                    return;
                }
                const data = await res.json();
                events = data.events || {};
                selectedEventIndex = null;
                selectDay(selectedDay);
                renderCalendar();
            } catch (e) {
                alert('Could not reach backend. Is it running on 127.0.0.1:8000?');
            }
        }

        async function onSlotClick(dayIndex, hour) {
            selectedDay = dayIndex;
            const title = prompt('Event title:');
            if (!title) return;
            const description = prompt('Description (optional):');
            const durationInput = prompt('Duration in hours (default: 1):');
            const duration = durationInput ? parseInt(durationInput) || 1 : 1;

            // Validate that the event fits within the 6am-8pm range
            const startHour = 6;
            const endHour = 20;
            if (hour < startHour || hour + duration > endHour + 1) {
                alert(`Event must be within ${startHour} to ${endHour} range.`);
                return;
            }

            // Check for overlapping events
            const key = formatDayKey(dayIndex);
            const dayEvents = events[key] || [];
            const hasOverlap = dayEvents.some(existingEvent => {
                const existingStart = Number(existingEvent.hour);
                const existingEnd = existingStart + (existingEvent.duration || 1);
                const newStart = hour;
                const newEnd = hour + duration;
                
                return (newStart < existingEnd && newEnd > existingStart);
            });

            if (hasOverlap) {
                alert('This time slot overlaps with an existing event. Please choose a different time.');
                return;
            }

            try {
                const res = await fetch(`${API_BASE}/events`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        day: key,
                        event: { title, description: description || '', hour: Number(hour), duration }
                    })
                });
                if (!res.ok) {
                    const err = await res.json().catch(() => ({}));
                    alert(err.detail || 'Failed to add event');
                    return;
                }
                const data = await res.json();
                events = data.events || {};
                renderCalendar();
                selectDay(selectedDay);
            } catch (e) {
                alert('Could not reach backend. Is it running on 127.0.0.1:8000?');
            }
        }

        async function loadEvents() {
            try {
                const res = await fetch(`${API_BASE}/events`);
                if (!res.ok) {
                    throw new Error('Failed to load events');
                }
                const data = await res.json();
                events = data.events || {};
            } catch (e) {
                // Keep empty events but notify user once
                console.warn('Could not load events from backend:', e);
            }
        }

        // Simple view switching
        function switchView(viewName) {
            const views = document.querySelectorAll('.view');
            views.forEach(v => v.classList.remove('active'));
            const target = document.getElementById(`view-${viewName}`);
            if (target) target.classList.add('active');

            const tabs = document.querySelectorAll('.nav-item');
            tabs.forEach(t => t.classList.remove('active'));
            const activeTab = document.querySelector(`.nav-item[data-view="${viewName}"]`);
            if (activeTab) activeTab.classList.add('active');

            if (viewName === 'calendar') {
                renderCalendar();
                if (selectedDay !== null) selectDay(selectedDay);
            } else if (viewName === 'notes') {
                initNotesView();
            }
        }

        document.querySelectorAll('.nav-item').forEach(btn => {
            btn.addEventListener('click', () => switchView(btn.dataset.view));
        });

        // Initialize calendar with backend data
        (async () => {
            await loadEvents();
            renderCalendar();
        })();

        // Make calendar responsive to window resize
        window.addEventListener('resize', () => {
            renderCalendar();
            if (selectedDay !== null) selectDay(selectedDay);
        });

        // Notes logic
        async function fetchNotes() {
            try {
                const res = await fetch(`${API_BASE}/notes`);
                if (!res.ok) throw new Error('Failed to load notes');
                const data = await res.json();
                return data.notes || [];
            } catch (e) {
                console.warn('Could not load notes from backend:', e);
                return [];
            }
        }

        async function createNote(text) {
            const res = await fetch(`${API_BASE}/notes`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ text })
            });
            if (!res.ok) throw new Error('Failed to create note');
            const data = await res.json();
            return data.notes || [];
        }

        async function updateNote(id, text) {
            const res = await fetch(`${API_BASE}/notes/${id}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ text })
            });
            if (!res.ok) throw new Error('Failed to update note');
            const data = await res.json();
            return data.notes || [];
        }

        async function deleteNote(id) {
            const res = await fetch(`${API_BASE}/notes/${id}`, { method: 'DELETE' });
            if (!res.ok) throw new Error('Failed to delete note');
            const data = await res.json();
            return data.notes || [];
        }

        function renderNotes(notes) {
            const list = document.getElementById('notesList');
            if (!list) return;
            list.innerHTML = '';

            // Existing notes
            notes.forEach(n => {
                const row = document.createElement('div');
                row.className = 'note-item';

                const textEl = document.createElement('div');
                textEl.className = 'note-text';
                textEl.contentEditable = 'true';
                textEl.textContent = n.text || '';
                textEl.dataset.placeholder = 'Click to edit note';
                textEl.addEventListener('blur', async () => {
                    const newText = textEl.innerText;
                    try {
                        await updateNote(n.id, newText);
                    } catch (e) {
                        alert('Failed to save note');
                    }
                });

                const del = document.createElement('button');
                del.className = 'note-delete';
                del.textContent = 'Delete';
                del.addEventListener('click', async () => {
                    try {
                        const updated = await deleteNote(n.id);
                        renderNotes(updated);
                    } catch (e) {
                        alert('Failed to delete note');
                    }
                });

                row.appendChild(textEl);
                row.appendChild(del);
                list.appendChild(row);
            });

            // Empty composer row always present at bottom
            const composer = document.createElement('div');
            composer.className = 'note-item';
            const input = document.createElement('div');
            input.className = 'note-text';
            input.contentEditable = 'true';
            input.dataset.placeholder = 'Add a note... (Cmd/Ctrl+Enter to save)';
            input.addEventListener('keydown', async (e) => {
                if (e.key === 'Enter' && (e.metaKey || e.ctrlKey)) {
                    e.preventDefault();
                    const text = input.innerText;
                    if (!text.trim()) return;
                    try {
                        const updated = await createNote(text);
                        renderNotes(updated);
                    } catch (err) {
                        alert('Failed to add note');
                    }
                }
            });
            composer.appendChild(input);
            list.appendChild(composer);
        }

        async function initNotesView() {
            const notes = await fetchNotes();
            renderNotes(notes);
        }

        // Export button inside calendar
        const calendarExportBtn = document.getElementById('calendarExportBtn');
        if (calendarExportBtn) {
            calendarExportBtn.addEventListener('click', () => switchView('export'));
        }

        // Modal structure
        const modalOverlay = document.createElement('div');
        modalOverlay.className = 'modal-overlay';
        modalOverlay.innerHTML = `
            <div class="modal" role="dialog" aria-modal="true">
                <div class="modal-title" id="modalTitle"></div>
                <div class="modal-subtitle" id="modalTime"></div>
                <div class="modal-description" id="modalDescription"></div>
                <div class="modal-actions">
                    <button class="btn-secondary" id="closeModalBtn">Close</button>
                    <button class="delete-button" id="deleteEventBtn">Delete</button>
                </div>
            </div>`;
        document.body.appendChild(modalOverlay);

        let modalCtx = { dayIndex: null, eventIndex: null };

        function openEventModal(dayIndex, eventIndex) {
            const dayKey = formatDayKey(dayIndex);
            const dayEvents = events[dayKey] || [];
            const ev = dayEvents[eventIndex];
            if (!ev) return;

            const hour = Number(ev.hour);
            const duration = ev.duration || 1;
            const start = `${String(hour).padStart(2,'0')}:00`;
            const end = `${String(hour + duration).padStart(2,'0')}:00`;

            document.getElementById('modalTitle').textContent = ev.title || 'Event';
            document.getElementById('modalTime').textContent = `${formatDisplayDay(dayIndex)} • ${start} - ${end} (${duration}h)`;
            document.getElementById('modalDescription').textContent = ev.description || '';

            modalCtx = { dayIndex, eventIndex };
            modalOverlay.style.display = 'flex';
        }

        function closeEventModal() {
            modalOverlay.style.display = 'none';
            modalCtx = { dayIndex: null, eventIndex: null };
        }

        modalOverlay.addEventListener('click', (e) => {
            if (e.target === modalOverlay) closeEventModal();
        });
        modalOverlay.querySelector('#closeModalBtn').addEventListener('click', closeEventModal);
        modalOverlay.querySelector('#deleteEventBtn').addEventListener('click', async () => {
            if (modalCtx.dayIndex === null || modalCtx.eventIndex === null) return;
            // Use existing deleteEvent helper
            const prevSelectedDay = selectedDay;
            selectedDay = modalCtx.dayIndex;
            await deleteEvent(modalCtx.eventIndex);
            selectedDay = prevSelectedDay;
            closeEventModal();
        });
    </script>
</body>
</html>